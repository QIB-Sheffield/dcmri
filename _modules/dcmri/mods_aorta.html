
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dcmri.mods_aorta &#8212; dcmri 0.6.8 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=cd8af66b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=ac3b80e6"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dcmri/mods_aorta';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/tristan-logo.jpg" class="logo__image only-light" alt="dcmri 0.6.8 documentation - Home"/>
    <script>document.write(`<img src="../../_static/tristan-logo.jpg" class="logo__image only-dark" alt="dcmri 0.6.8 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial/index.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../generated/examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute/index.html">
    Contribute
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../releases/index.html">
    Releases
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../about/index.html">
    About
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/QIB-Sheffield/dcmri" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial/index.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../generated/examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute/index.html">
    Contribute
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../releases/index.html">
    Releases
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/QIB-Sheffield/dcmri" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">dcmri.mods_aorta</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for dcmri.mods_aorta</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dcmri</span> <span class="k">as</span> <span class="nn">dc</span>


<div class="viewcode-block" id="Aorta">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta">[docs]</a>
<span class="k">class</span> <span class="nc">Aorta</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whole-body model for aorta signal.</span>

<span class="sd">    The model represents the body as a leaky loop with a heart-lung system and an organ system. The heart-lung system is modelled as a chain compartment and the organs are modelled as a two-compartment exchange model. Bolus injection into the system is modelled as a step function.</span>
<span class="sd">    </span>
<span class="sd">        **Injection parameters**</span>

<span class="sd">        - **weight** (float, default=70): Subject weight in kg.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **dose** (float, default=0.2): Injected contrast agent dose in mL per kg bodyweight.</span>
<span class="sd">        - **rate** (float, default=1): Contrast agent injection rate in mL per sec.</span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): Signal model.</span>
<span class="sd">        - **tmax** (float, default=120): Maximum acquisition time in sec.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T. </span>
<span class="sd">        - **t0** (float, default=1): Baseline length in secs.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec. </span>
<span class="sd">        - **FA** (float, default=15): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **R10** (float, default=1): Precontrast arterial relaxation rate in 1/sec. </span>
<span class="sd">        - **S0** (float, default=1): scale factor for the arterial MR signal in the first scan. </span>

<span class="sd">        **Whole body kinetic parameters**</span>

<span class="sd">        - **heartlung** (str, default=&#39;pfcomp&#39;): Kinetic model for the heart-lung system (either &#39;pfcomp&#39; or &#39;chain&#39;).</span>
<span class="sd">        - **organs** (str, default=&#39;2cxm&#39;): Kinetic model for the organs.</span>
<span class="sd">        - **BAT** (float, default=60): Bolus arrival time, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **BAT2** (float, default=1200): Bolus arrival time in the second scan, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **CO** (float, default=100): Cardiac output in mL/sec.</span>
<span class="sd">        - **Thl** (float, default=10): Mean transit time through heart and lungs.</span>
<span class="sd">        - **Dhl** (float, default=0.2): Dispersion through the heart-lung system, with a value in the range [0,1].</span>
<span class="sd">        - **To** (float, default=20): average time to travel through the organ&#39;s vasculature.</span>
<span class="sd">        - **Eb** (float, default=0.05): fraction of indicator extracted from the vasculature in a single pass. </span>
<span class="sd">        - **Eo** (float, default=0.15): Fraction of indicator entering the organs which is extracted from the blood pool.</span>
<span class="sd">        - **Teb** (float, default=120): Average time to travel through the organs extravascular space.</span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **dt** (float, default=1): Internal time resolution of the AIF in sec. </span>
<span class="sd">        - **dose_tolerance** (fload, default=0.1): Stopping criterion for the whole-body model.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AortaLiver`</span>

<span class="sd">    Example:</span>

<span class="sd">        Use the model to reconstruct concentrations from experimentally derived signals.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_tissue` to generate synthetic test data from experimentally-derived concentrations:</span>

<span class="sd">        &gt;&gt;&gt; time, aif, _, gt = dc.fake_tissue()</span>
<span class="sd">        </span>
<span class="sd">        Build an aorta model and set weight, contrast agent, dose and rate to match the conditions of the original experiment (`Parker et al 2006 &lt;https://doi.org/10.1002/mrm.21066&gt;`_):</span>

<span class="sd">        &gt;&gt;&gt; aorta = dc.Aorta(</span>
<span class="sd">        ...     dt = 1.5,</span>
<span class="sd">        ...     weight = 70,</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     dose = 0.2,</span>
<span class="sd">        ...     rate = 3,</span>
<span class="sd">        ...     field_strength = 3.0,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = 20,</span>
<span class="sd">        ...     R10 = 1/dc.T1(3.0,&#39;blood&#39;),</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the data:</span>

<span class="sd">        &gt;&gt;&gt; aorta.train(time, aif)</span>

<span class="sd">        Plot the reconstructed signals and concentrations and compare against the experimentally derived data:</span>

<span class="sd">        &gt;&gt;&gt; aorta.plot(time, aif)</span>

<span class="sd">        We can also have a look at the model parameters after training:</span>

<span class="sd">        &gt;&gt;&gt; aorta.print_params(round_to=3)</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Free parameters with their errors (stdev)</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Bolus arrival time (BAT): 18.485 (5.656) sec</span>
<span class="sd">        Cardiac output (CO): 228.237 (29.321) mL/sec</span>
<span class="sd">        Heart-lung mean transit time (Thl): 9.295 (6.779) sec</span>
<span class="sd">        Heart-lung transit time dispersion (Dhl): 0.459 (0.177)</span>
<span class="sd">        Organs mean transit time (To): 29.225 (11.646) sec</span>
<span class="sd">        Extraction fraction (Eb): 0.013 (0.972)</span>
<span class="sd">        Organs extraction fraction (Eo): 0.229 (0.582)</span>
<span class="sd">        Extracellular mean transit time (Te): 97.626 (640.454) sec</span>
<span class="sd">        ------------------</span>
<span class="sd">        Derived parameters</span>
<span class="sd">        ------------------</span>
<span class="sd">        Mean circulation time (Tc): 38.521 sec</span>

<span class="sd">        *Note*: The extracellular mean transit time has a high error, indicating that the acquisition time here is insufficient to resolve the transit through the leakage space.</span>
<span class="sd">    &quot;&quot;&quot;</span>         

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">120</span>             
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">70.0</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">ca_std_dose</span><span class="p">(</span><span class="s1">&#39;gadoterate&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mf">15.0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.180</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="mf">60.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CO</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eb</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Te</span> <span class="o">=</span> <span class="mi">120</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">=</span> <span class="s1">&#39;2cxm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span> <span class="o">=</span> <span class="s1">&#39;pfcomp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">800</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># Override defaults</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<div class="viewcode-block" id="Aorta.conc">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.conc">[docs]</a>
    <span class="k">def</span> <span class="nf">conc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aorta blood concentration</span>

<span class="sd">        Args:</span>
<span class="sd">            t (array-like): Time points of the concentration (sec)</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Concentration in M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2cxm&#39;</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">)]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">ca_conc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="n">Ji</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">influx_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> 
                <span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">)</span> 
        <span class="n">Jb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux_aorta</span><span class="p">(</span><span class="n">Ji</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Eb</span><span class="p">,</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)],</span>
            <span class="n">organs</span><span class="o">=</span><span class="n">organs</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">Jb</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CO</span></div>


<div class="viewcode-block" id="Aorta.relax">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.relax">[docs]</a>
    <span class="k">def</span> <span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aorta longitudinal relation rate</span>

<span class="sd">        Args:</span>
<span class="sd">            t (array-like): Time points of the concentration (sec)</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Concentration in M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">()</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">cb</span></div>


<div class="viewcode-block" id="Aorta.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">+</span><span class="n">tacq</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_src(R1, self.S0, self.TC, R10=self.R10)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_src</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_ss(R1, self.S0, self.TR, self.FA, R10=self.R10)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">tacq</span><span class="p">)</span></div>


<div class="viewcode-block" id="Aorta.train">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdata</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ydata</span><span class="p">)]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">Sref</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_src</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Sref</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Aorta.export_params">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.export_params">[docs]</a>
    <span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bolus arrival time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CO&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cardiac output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CO</span><span class="p">,</span> <span class="s2">&quot;mL/sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Thl&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Heart-lung mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Dhl&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Heart-lung transit time dispersion&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Organs mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eb&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eb</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mean circulation time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Organs extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Extracellular mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="c1">#pars[&#39;S0&#39;] = [&quot;Baseline&quot;, self.S0, &quot;au&quot;]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_sdev</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Aorta.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.Aorta.html#dcmri.Aorta.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  
            <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">aif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">xdata</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction of the MRI signals.&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measurement&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">aif</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MRI signal (a.u.)&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction of the concentrations.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground truth&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Blood concentration (mM)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>

    

<div class="viewcode-block" id="AortaLiver">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver">[docs]</a>
<span class="k">class</span> <span class="nc">AortaLiver</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Joint model for aorta and liver signals.</span>

<span class="sd">    The model represents the liver as a two-compartment system and the body as a leaky loop with a heart-lung system and an organ system. The heart-lung system is modelled as a chain compartment and the organs are modelled as a two-compartment exchange model. Bolus injection into the system is modelled as a step function.</span>
<span class="sd">    </span>
<span class="sd">        **Injection parameters**</span>

<span class="sd">        - **weight** (float, default=70): Subject weight in kg.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **dose** (float, default=0.2): Injected contrast agent dose in mL per kg bodyweight.</span>
<span class="sd">        - **rate** (float, default=1): Contrast agent injection rate in mL per sec.</span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): Signal model.</span>
<span class="sd">        - **tmax** (float, default=120): Maximum acquisition time in sec.</span>
<span class="sd">        - **tacq** (float, default=None): Time to acquire a single dynamic in the first scan (sec). If this is not provided, tacq is taken from the difference between the first two data points.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T. </span>
<span class="sd">        - **t0** (float, default=1): Baseline length in secs.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec. </span>
<span class="sd">        - **FA** (float, default=15): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **R10b** (float, default=1): Precontrast arterial relaxation rate in 1/sec.  </span>
<span class="sd">        - **R10l** (float, default=1): Baseline R1 for the liver.</span>
<span class="sd">        - **S0b** (float, default=1): scale factor for the arterial MR signal in the first scan.</span>
<span class="sd">        - **S0l** (float, default=1): Scale factor for the liver signal.   </span>

<span class="sd">        **Whole body kinetic parameters**</span>

<span class="sd">        - **organs** (str, default=&#39;2cxm&#39;): Kinetic model for the organs.</span>
<span class="sd">        - **BAT** (float, default=60): Bolus arrival time, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **BAT2** (float, default=1200): Bolus arrival time in the second scan, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **CO** (float, default=100): Cardiac output in mL/sec.</span>
<span class="sd">        - **Thl** (float, default=10): Mean transit time through heart and lungs.</span>
<span class="sd">        - **Dhl** (float, default=0.2): Dispersion through the heart-lung system, with a value in the range [0,1].</span>
<span class="sd">        - **To** (float, default=20): average time to travel through the organ&#39;s vasculature.</span>
<span class="sd">        - **Eb** (float, default=0.05): fraction of indicator extracted from the vasculature in a single pass. </span>
<span class="sd">        - **Eo** (float, default=0.15): Fraction of indicator entering the organs which is extracted from the blood pool.</span>
<span class="sd">        - **Teb** (float, default=120): Average time to travel through the organs extravascular space.</span>

<span class="sd">        **Liver kinetic parameters**</span>

<span class="sd">        - **kinetics** (str, default=&#39;stationary&#39;). Liver kinetic model, either stationary or non-stationary.</span>
<span class="sd">        - **Hct** (float, default=0.45): Hematocrit.</span>
<span class="sd">        - **Tel** (float, default=30): Mean transit time for extracellular space of liver and gut.</span>
<span class="sd">        - **De** (float, default=0.85): Dispersion in the extracellular space of liver an gut, in the range [0,1].</span>
<span class="sd">        - **ve** (float, default=0.3): Liver extracellular volume fraction.</span>
<span class="sd">        - **khe** (float, default=0.003): Hepatocellular uptake rate.</span>
<span class="sd">        - **Th** (float, default=1800): Hepatocellular transit time.</span>
<span class="sd">        - **khe_f** (float, default=0.003): Final hepatocellular uptake rate (non-stationary models).</span>
<span class="sd">        - **Th_f** (float, default=1800): Final hepatocellular transit time (non-stationary models).</span>
<span class="sd">        - **vol** (float, default=None): liver volume in mL (for whole liver export parameters).</span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **dt** (float, default=1): Internal time resolution of the AIF in sec. </span>
<span class="sd">        - **dose_tolerance** (fload, default=0.1): Stopping criterion for the whole-body model.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AortaLiver`</span>

<span class="sd">    Example:</span>

<span class="sd">        Use the model to reconstruct concentrations from experimentally derived signals.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_tissue` to generate synthetic test data from experimentally-derived concentrations:</span>

<span class="sd">        &gt;&gt;&gt; time, aif, roi, gt = dc.fake_tissue()</span>
<span class="sd">        &gt;&gt;&gt; xdata, ydata = (time,time), (aif,roi)</span>
<span class="sd">        </span>
<span class="sd">        Build an aorta-liver model and parameters to match the conditions of the fake tissue data:</span>

<span class="sd">        &gt;&gt;&gt; model = dc.AortaLiver(</span>
<span class="sd">        ...     dt = 0.5,</span>
<span class="sd">        ...     tmax = 180,</span>
<span class="sd">        ...     weight = 70,</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     dose = 0.2,</span>
<span class="sd">        ...     rate = 3,</span>
<span class="sd">        ...     field_strength = 3.0,</span>
<span class="sd">        ...     t0 = 10,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = 20,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the data:</span>

<span class="sd">        &gt;&gt;&gt; model.train(xdata, ydata, xtol=1e-3)</span>

<span class="sd">        Plot the reconstructed signals and concentrations and compare against the experimentally derived data:</span>

<span class="sd">        &gt;&gt;&gt; model.plot(xdata, ydata)</span>

<span class="sd">        We can also have a look at the model parameters after training:</span>

<span class="sd">        &gt;&gt;&gt; model.print_params(round_to=3)</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Free parameters with their errors (stdev)</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Bolus arrival time (BAT): 17.127 (2.838) sec</span>
<span class="sd">        Cardiac output (CO): 211.047 (13.49) mL/sec</span>
<span class="sd">        Heart-lung mean transit time (Thl): 12.503 (3.527) sec</span>
<span class="sd">        Heart-lung transit time dispersion (Dhl): 0.465 (0.063)</span>
<span class="sd">        Organs mean transit time (To): 28.413 (10.294) sec</span>
<span class="sd">        Extraction fraction (Eb): 0.01 (0.623)</span>
<span class="sd">        Liver extracellular mean transit time (Tel): 2.915 (0.588) sec</span>
<span class="sd">        Liver extracellular dispersion (De): 1.0 (0.19)</span>
<span class="sd">        Liver extracellular volume fraction (ve): 0.176 (0.015) mL/mL</span>
<span class="sd">        Hepatocellular uptake rate (khe): 0.005 (0.001) mL/sec/mL</span>
<span class="sd">        Hepatocellular transit time (Th): 600.0 (747.22) sec</span>
<span class="sd">        Organs extraction fraction (Eo): 0.261 (0.324)</span>
<span class="sd">        Organs extracellular mean transit time (Teb): 81.765 (329.097) sec</span>
<span class="sd">        ------------------</span>
<span class="sd">        Derived parameters</span>
<span class="sd">        ------------------</span>
<span class="sd">        Blood precontrast T1 (T10b): 1.629 sec</span>
<span class="sd">        Mean circulation time (Tc): 40.916 sec</span>
<span class="sd">        Liver precontrast T1 (T10l): 0.752 sec</span>
<span class="sd">        Biliary excretion rate (kbh): 0.001 mL/sec/mL</span>
<span class="sd">        Hepatocellular tissue uptake rate (Khe): 0.026 mL/sec/mL</span>
<span class="sd">        Biliary tissue excretion rate (Kbh): 0.002 mL/sec/mL</span>

<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">120</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="o">=</span> <span class="kc">None</span>           
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">70.0</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mf">15.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.180</span>
        
        <span class="c1"># Aorta parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;blood&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CO</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eb</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span> <span class="o">=</span> <span class="mi">120</span>

        <span class="c1"># Liver parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span> <span class="o">=</span> <span class="mf">0.45</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">R10l</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;liver&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span> <span class="o">=</span> <span class="mf">30.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">De</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ve</span> <span class="o">=</span> <span class="mf">0.3</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">khe</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Th</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">=</span> <span class="s1">&#39;2cxm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">=</span> <span class="s1">&#39;stationary&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Tel&#39;</span><span class="p">,</span><span class="s1">&#39;De&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span><span class="s1">&#39;khe&#39;</span><span class="p">,</span><span class="s1">&#39;Th&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Teb&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">800</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># Override defaults</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Internal flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_conc_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2cxm&#39;</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">ca_conc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="n">Ji</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">influx_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> 
                <span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">)</span>
        <span class="n">Jb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux_aorta</span><span class="p">(</span><span class="n">Ji</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Eb</span><span class="p">,</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pfcomp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)],</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="n">organs</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">Jb</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">cb</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span>
    
    <span class="k">def</span> <span class="nf">_relax_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_aorta</span><span class="p">()</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">cb</span>

    <span class="k">def</span> <span class="nf">_predict_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">+</span><span class="n">tacq</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_aorta</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_src(R1b, self.S0b, self.TC, R10=self.R10b)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_src</span><span class="p">(</span><span class="n">R1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_ss(R1b, self.S0b, self.TR, self.FA, R10=self.R10b)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">tacq</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_conc_liver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;non-stationary&#39;</span><span class="p">:</span>
            <span class="n">khe</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">interp</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)],</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">Kbh</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">interp</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_liver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">De</span><span class="p">,</span> <span class="n">khe</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">Kbh</span><span class="p">,</span>
                    <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;ICNS&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;non-stationary uptake&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span>
            <span class="n">khe</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">interp</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)],</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_liver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">De</span><span class="p">,</span> <span class="n">khe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span>
                    <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;ICNSU&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;stationary&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span>
            <span class="n">khe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_liver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">De</span><span class="p">,</span> <span class="n">khe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span>
                    <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;IC&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_relax_liver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">Cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_liver</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="n">rh</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;hepatocytes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10l</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">Cl</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rh</span><span class="o">*</span><span class="n">Cl</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
    
    <span class="k">def</span> <span class="nf">_predict_liver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_liver</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_sr(R1l, self.S0l, self.TR, self.FA, self.TC, R10=R1l[0])</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_ss(R1l, self.S0l, self.TR, self.FA, R10=R1l[0])</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">tacq</span><span class="p">)</span>
    
<div class="viewcode-block" id="AortaLiver.conc">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.conc">[docs]</a>
    <span class="k">def</span> <span class="nf">conc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concentrations in aorta and liver.</span>

<span class="sd">        Args:</span>
<span class="sd">            sum (bool, optional): If set to true, the liver concentrations are the sum over both compartments. If set to false, the compartmental concentrations are returned individually. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: time points, aorta blood concentrations, liver concentrations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_aorta</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_liver</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">C</span></div>

    
<div class="viewcode-block" id="AortaLiver.relax">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.relax">[docs]</a>
    <span class="k">def</span> <span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relaxation rates in aorta and liver.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: time points, aorta blood concentrations, liver concentrations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_aorta</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_liver</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span><span class="p">,</span> <span class="n">R1l</span></div>


<div class="viewcode-block" id="AortaLiver.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the data at given xdata</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 2 arrays with time points for aorta and liver, in that order. The two arrays can be different in length and value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: tuple of 2 arrays with signals for aorta and liver, in that order. The arrays can be different in length and value but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Public interface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signala</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">signall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_liver</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">signala</span><span class="p">,</span> <span class="n">signall</span>
        <span class="c1"># Private interface with different input &amp; output types</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;aorta&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;liver&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_liver</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span></div>


<div class="viewcode-block" id="AortaLiver.train">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> 
              <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the free parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 2 arrays with time points for aorta and liver, in that order. The two arrays can be different in length and value.</span>
<span class="sd">            ydata (array-like): tuple of 2 arrays with signals for aorta and liver, in that order. The arrays can be different in length and value but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            kwargs: any keyword parameters accepted by `scipy.optimize.curve_fit`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Model: A reference to the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Estimate BAT and S0b from data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Srefl</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Srefl</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Srefb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Srefl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Train free aorta parameters on aorta data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;aorta&#39;</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Teb&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Train free liver parameters on liver data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;liver&#39;</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tel&#39;</span><span class="p">,</span><span class="s1">&#39;De&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span><span class="s1">&#39;khe&#39;</span><span class="p">,</span><span class="s1">&#39;Th&#39;</span><span class="p">,</span><span class="s1">&#39;khe_f&#39;</span><span class="p">,</span><span class="s1">&#39;Th_f&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Train all parameters on all data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AortaLiver.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> 
                <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span>  
                <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the model fit against data</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 2 arrays with time points for aorta and liver, in that order. The two arrays can be different in length and value.</span>
<span class="sd">            ydata (array-like): tuple of 2 arrays with signals for aorta and liver, in that order. The arrays can be different in length and value but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            xlim (array_like, optional): 2-element array with lower and upper boundaries of the x-axis. Defaults to None.</span>
<span class="sd">            ref (tuple, optional): Tuple of optional test data in the form (x,y), where x is an array with x-values and y is an array with y-values. Defaults to None.</span>
<span class="sd">            fname (path, optional): Filepath to save the image. If no value is provided, the image is not saved. Defaults to None.</span>
<span class="sd">            show (bool, optional): If True, the plot is shown. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">ax1</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span><span class="s1">&#39;darkred&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">ax3</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span><span class="s1">&#39;darkblue&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_plot_conc_aorta</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="n">_plot_conc_liver</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="AortaLiver.export_params">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.export_params">[docs]</a>
    <span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Aorta</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;T10b&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Blood precontrast T1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bolus arrival time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CO&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cardiac output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CO</span><span class="p">,</span> <span class="s2">&quot;mL/sec&quot;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Thl&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Heart-lung mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Dhl&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Heart-lung transit time dispersion&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eb&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eb</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Mean circulation time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eo&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Teb&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs extracellular mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="c1"># Liver</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;T10l&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Liver precontrast T1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R10l</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Tel&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Liver extracellular mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;De&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Liver extracellular dispersion&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">De</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Liver extracellular volume fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="s1">&#39;mL/mL&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span><span class="o">==</span><span class="s1">&#39;stationary&#39;</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;khe&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular uptake rate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Th&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;kbh&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary excretion rate&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Khe&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular tissue uptake rate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Kbh&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary tissue excretion rate&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CL&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Liver blood clearance&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">khe</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span><span class="p">]</span>
            <span class="n">Kbh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span><span class="p">]</span>
            <span class="n">khe_avr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">khe</span><span class="p">)</span>
            <span class="n">Kbh_avr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Kbh</span><span class="p">)</span>
            <span class="n">khe_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">khe</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">khe</span><span class="p">))</span><span class="o">/</span><span class="n">khe_avr</span>
            <span class="n">Kbh_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Kbh</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Kbh</span><span class="p">))</span><span class="o">/</span><span class="n">Kbh_avr</span> 
            <span class="n">kbh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span><span class="o">*</span><span class="n">Kbh_avr</span><span class="p">)</span>
            <span class="n">Th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Kbh_avr</span><span class="p">)</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;khe&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular uptake rate&quot;</span><span class="p">,</span> <span class="n">khe_avr</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Th&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular transit time&quot;</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;kbh&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary excretion rate&quot;</span><span class="p">,</span> <span class="n">kbh</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Khe&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular tissue uptake rate&quot;</span><span class="p">,</span> <span class="n">khe_avr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Kbh&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary tissue excretion rate&quot;</span><span class="p">,</span> <span class="n">Kbh_avr</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;khe_i&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular uptake rate (initial)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;khe_f&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular uptake rate (final)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Th_i&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular transit time (initial)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Th_f&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular transit time (final)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;khe_var&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Hepatocellular uptake rate variance&quot;</span><span class="p">,</span> <span class="n">khe_var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Kbh_var&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary tissue excretion rate variance&quot;</span><span class="p">,</span> <span class="n">Kbh_var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;kbh_i&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary excretion rate (initial)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;kbh_f&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Biliary excretion rate (final)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CL&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Liver blood clearance&#39;</span><span class="p">,</span> <span class="n">khe_avr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_sdev</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AortaLiver.cost">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver.html#dcmri.AortaLiver.cost">[docs]</a>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;NRMS&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the goodness-of-fit</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 2 arrays with time points for aorta and liver, in that order. The two arrays can be different in length and value.</span>
<span class="sd">            ydata (array-like): tuple of 2 arrays with signals for aorta and liver, in that order. The arrays can be different in length and value but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            metric (str, optional): Which metric to use - options are: </span>
<span class="sd">                **RMS** (Root-mean-square);</span>
<span class="sd">                **NRMS** (Normalized root-mean-square); </span>
<span class="sd">                **AIC** (Akaike information criterion); </span>
<span class="sd">                **cAIC** (Corrected Akaike information criterion for small models);</span>
<span class="sd">                **BIC** (Baysian information criterion). Defaults to &#39;NRMS&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: goodness of fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span></div>
</div>


    


<div class="viewcode-block" id="AortaKidneys">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys">[docs]</a>
<span class="k">class</span> <span class="nc">AortaKidneys</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Joint model for aorta and kidneys signals.</span>

<span class="sd">    The model represents the kidneys as a two-compartment filtration system and the body as a leaky loop with a heart-lung system and an organ system. The heart-lung system is modelled as a chain compartment and the organs are modelled as a compartment or a two-compartment exchange model. Bolus injection into the system is modelled as a step function.</span>
<span class="sd">    </span>
<span class="sd">        **Injection parameters**</span>

<span class="sd">        - **weight** (float, default=70): Subject weight in kg.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **dose** (float, default=0.2): Injected contrast agent dose in mL per kg bodyweight.</span>
<span class="sd">        - **rate** (float, default=1): Contrast agent injection rate in mL per sec.</span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): Signal model.</span>
<span class="sd">        - **tmax** (float, default=120): Maximum acquisition time in sec.</span>
<span class="sd">        - **tacq** (float, default=None): Time to acquire a single dynamic in the first scan (sec). If this is not provided, tacq is taken from the difference between the first two data points.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T. </span>
<span class="sd">        - **n0** (float, default=1): Baseline length in nr of scans.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec. </span>
<span class="sd">        - **FA** (float, default=15): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **R10b** (float, default=1): Precontrast arterial relaxation rate in 1/sec. </span>
<span class="sd">        - **S0b** (float, default=1): scale factor for the arterial MR signal in the first scan. </span>
<span class="sd">        - **R10_lk** (float, default=1): Baseline R1 for the left kidney.</span>
<span class="sd">        - **S0_lk** (float, default=1): Scale factor for the left kidney signal. </span>
<span class="sd">        - **R10_rk** (float, default=1): Baseline R1 for the right kidney.</span>
<span class="sd">        - **S0_rk** (float, default=1): Scale factor for the right kidney signal.   </span>

<span class="sd">        **Whole body kinetic parameters**</span>

<span class="sd">        - **organs** (str, default=&#39;2cxm&#39;): Kinetic model for the organs.</span>
<span class="sd">        - **BAT** (float, default=60): Bolus arrival time, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **BAT2** (float, default=1200): Bolus arrival time in the second scan, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **CO** (float, default=100): Cardiac output in mL/sec.</span>
<span class="sd">        - **Eb** (float, default=0.05): fraction of indicator extracted from the vasculature in a single pass. </span>
<span class="sd">        - **Thl** (float, default=10): Mean transit time through heart and lungs.</span>
<span class="sd">        - **Dhl** (float, default=0.2): Dispersion through the heart-lung system, with a value in the range [0,1].</span>
<span class="sd">        - **To** (float, default=20): average time to travel through the organ&#39;s vasculature.</span>
<span class="sd">        - **Eo** (float, default=0.15): Fraction of indicator entering the organs which is extracted from the blood pool.</span>
<span class="sd">        - **Teb** (float, default=120): Average time to travel through the organs extravascular space.</span>

<span class="sd">        **Kidney kinetic parameters**</span>

<span class="sd">        - **kinetics** (str, default=&#39;2CFM&#39;). Kidney kinetic model (only one option at this stage).</span>
<span class="sd">        - **Hct** (float, default=0.45): Hematocrit.</span>
<span class="sd">        - **Fp_lk** (Plasma flow, mL/sec/mL): Flow of plasma into the plasma compartment (left kidney).</span>
<span class="sd">        - **Tp_lk** (Plasma mean transit time, sec): Transit time of the plasma compartment (left kidney). </span>
<span class="sd">        - **Ft_lk** (Tubular flow, mL/sec/mL): Flow of fluid into the tubuli (left kidney).</span>
<span class="sd">        - **Tt_lk** (Tubular mean transit time, sec): Transit time of the tubular compartment (left kidney).</span>
<span class="sd">        - **Ta_lk** (Arterial delay time, sec): Transit time through the arterial compartment (left kidney). </span>
<span class="sd">        - **Fp_rk** (Plasma flow, mL/sec/mL): Flow of plasma into the plasma compartment (right kidney).</span>
<span class="sd">        - **Tp_rk** (Plasma mean transit time, sec): Transit time of the plasma compartment (right kidney). </span>
<span class="sd">        - **Ft_rk** (Tubular flow, mL/sec/mL): Flow of fluid into the tubuli (right kidney).</span>
<span class="sd">        - **Tt_rk** (Tubular mean transit time, sec): Transit time of the tubular compartment (right kidney).</span>
<span class="sd">        - **Ta_rk** (Arterial delay time, sec): Transit time through the arterial compartment (right kidney). </span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **dt** (float, default=1): Internal time resolution of the AIF in sec. </span>
<span class="sd">        - **dose_tolerance** (fload, default=0.1): Stopping criterion for the whole-body model.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">        **Additional parameters**</span>

<span class="sd">        - **vol_lk** (float, optional): Kidney volume in mL (left kidney).</span>
<span class="sd">        - **vol_rk** (float, optional): Kidney volume in mL (right kidney).</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AortaLiver`</span>

<span class="sd">    Example:</span>

<span class="sd">        Use the model to reconstruct concentrations from experimentally derived signals.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_tissue` to generate synthetic test data from experimentally-derived concentrations:</span>

<span class="sd">        &gt;&gt;&gt; time, aif, roi, gt = dc.fake_tissue()</span>
<span class="sd">        &gt;&gt;&gt; xdata, ydata = (time,time,time), (aif,roi,roi)</span>
<span class="sd">        </span>
<span class="sd">        Build an aorta-kidney model and parameters to match the conditions of the fake tissue data:</span>

<span class="sd">        &gt;&gt;&gt; model = dc.AortaKidneys(</span>
<span class="sd">        ...     dt = 0.5,</span>
<span class="sd">        ...     tmax = 180,</span>
<span class="sd">        ...     weight = 70,</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     dose = 0.2,</span>
<span class="sd">        ...     rate = 3,</span>
<span class="sd">        ...     field_strength = 3.0,</span>
<span class="sd">        ...     t0 = 10,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = 20,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the data:</span>

<span class="sd">        &gt;&gt;&gt; model.train(xdata, ydata, xtol=1e-3)</span>

<span class="sd">        Plot the reconstructed signals and concentrations and compare against the experimentally derived data:</span>

<span class="sd">        &gt;&gt;&gt; model.plot(xdata, ydata)</span>

<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">120</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="o">=</span> <span class="kc">None</span>           
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">70.0</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n0</span> <span class="o">=</span> <span class="mi">1</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mf">15.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.180</span>
        
        <span class="c1"># Aorta parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;blood&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CO</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FF</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span> <span class="o">=</span> <span class="mf">0.45</span>

        <span class="c1"># Kidneys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RPF</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># mL/sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DRF</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># Left kidney parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10_lk</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;kidney&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0_lk</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">Ta_lk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_lk</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tt_lk</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span> <span class="o">=</span> <span class="mi">150</span>

        <span class="c1"># Right kidney parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10_rk</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;kidney&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0_rk</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">Ta_rk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_rk</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tt_rk</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span> <span class="o">=</span> <span class="mi">150</span>

        <span class="c1"># Configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">=</span> <span class="s1">&#39;comp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span> <span class="o">=</span> <span class="s1">&#39;pfcomp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kidneys</span> <span class="o">=</span> <span class="s1">&#39;2CF&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span> <span class="s1">&#39;FF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;RPF&#39;</span><span class="p">,</span><span class="s1">&#39;DRPF&#39;</span><span class="p">,</span> <span class="s1">&#39;DRF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;vp_lk&#39;</span><span class="p">,</span><span class="s1">&#39;Tt_lk&#39;</span><span class="p">,</span><span class="c1">#&#39;Ta_lk&#39;,</span>
                <span class="s1">&#39;vp_rk&#39;</span><span class="p">,</span><span class="s1">&#39;Tt_rk&#39;</span><span class="p">]</span><span class="c1">#&#39;Ta_rk&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span>   <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="c1">#5,</span>
                <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="c1">#5],</span>
        <span class="p">]</span>

        <span class="c1"># Override defaults</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 

        <span class="c1"># Internal flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_conc_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2cxm&#39;</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span> <span class="o">==</span> <span class="s1">&#39;pfcomp&#39;</span><span class="p">:</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pfcomp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartlung</span> <span class="o">==</span> <span class="s1">&#39;chain&#39;</span><span class="p">:</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">ca_conc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="n">Ji</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">influx_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> 
                <span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">)</span>
        <span class="n">Jb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux_aorta</span><span class="p">(</span><span class="n">Ji</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FF</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">FF</span><span class="p">),</span>
                <span class="n">heartlung</span><span class="o">=</span><span class="n">heartlung</span><span class="p">,</span> <span class="n">organs</span><span class="o">=</span><span class="n">organs</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">Jb</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">cb</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span>
    
    <span class="k">def</span> <span class="nf">_relax_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_aorta</span><span class="p">()</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">cb</span>

    <span class="k">def</span> <span class="nf">_predict_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">+</span><span class="n">tacq</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_aorta</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_src(R1b, self.S0b, self.TC, R10=self.R10b)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_src</span><span class="p">(</span><span class="n">R1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#signal = dc.signal_ss(R1b, self.S0b, self.TR, self.FA, R10=self.R10b)</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">tacq</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_conc_kidneys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="n">ca_lk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ta_lk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;plug&#39;</span><span class="p">)</span>
        <span class="n">ca_rk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ta_rk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;plug&#39;</span><span class="p">)</span>
        <span class="n">GFR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPF</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FF</span>
        <span class="n">GFR_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRF</span><span class="o">*</span><span class="n">GFR</span>
        <span class="n">GFR_rk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DRF</span><span class="p">)</span><span class="o">*</span><span class="n">GFR</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidneys</span> <span class="o">==</span> <span class="s1">&#39;2CF&#39;</span><span class="p">:</span>
            <span class="n">RPF_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">RPF</span>
            <span class="n">RPF_rk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">RPF</span>
            <span class="n">Tp_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_lk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="o">/</span><span class="n">RPF_lk</span>
            <span class="n">Tp_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_rk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="o">/</span><span class="n">RPF_rk</span>
            <span class="c1"># TODO reparametrize conc_kidney 2CF with vp instead of Tp</span>
            <span class="n">Nlk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_kidney</span><span class="p">(</span><span class="n">ca_lk</span><span class="p">,</span> <span class="n">RPF_lk</span><span class="p">,</span> <span class="n">Tp_lk</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_lk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;2CF&#39;</span><span class="p">)</span>
            <span class="n">Nrk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_kidney</span><span class="p">(</span><span class="n">ca_rk</span><span class="p">,</span> <span class="n">RPF_rk</span><span class="p">,</span> <span class="n">Tp_rk</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_rk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;2CF&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidneys</span> <span class="o">==</span> <span class="s1">&#39;HF&#39;</span><span class="p">:</span>
            <span class="n">Nlk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_kidney</span><span class="p">(</span><span class="n">ca_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_lk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_lk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span>
            <span class="n">Nrk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_kidney</span><span class="p">(</span><span class="n">ca_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_rk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_rk</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">Nlk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="p">,</span> <span class="n">Nrk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span>

    
    <span class="k">def</span> <span class="nf">_relax_kidneys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">Clk</span><span class="p">,</span> <span class="n">Crk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_kidneys</span><span class="p">()</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10_lk</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">Clk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10_rk</span> <span class="o">+</span> <span class="n">rp</span><span class="o">*</span><span class="n">Crk</span>
    
    <span class="k">def</span> <span class="nf">_predict_kidneys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1_lk</span><span class="p">,</span> <span class="n">R1_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_kidneys</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">signal_lk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">signal_rk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal_lk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0_lk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">signal_rk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal_lk</span><span class="p">,</span> <span class="n">tacq</span><span class="p">),</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">signal_rk</span><span class="p">,</span> <span class="n">tacq</span><span class="p">))</span>
    
<div class="viewcode-block" id="AortaKidneys.conc">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.conc">[docs]</a>
    <span class="k">def</span> <span class="nf">conc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concentrations in aorta and kidney.</span>

<span class="sd">        Args:</span>
<span class="sd">            sum (bool, optional): If set to true, the kidney concentrations are the sum over all compartments. If set to false, the compartmental concentrations are returned individually. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: time points, aorta blood concentrations, left kidney concentrations, right kidney concentrations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_aorta</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">Clk</span><span class="p">,</span> <span class="n">Crk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conc_kidneys</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">Clk</span><span class="p">,</span> <span class="n">Crk</span></div>

    
<div class="viewcode-block" id="AortaKidneys.relax">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.relax">[docs]</a>
    <span class="k">def</span> <span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relaxation rates in aorta and kidney.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: time points, aorta relaxation rate, left kidney relaxation rate, right kidney relaxation rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_aorta</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1_lk</span><span class="p">,</span> <span class="n">R1_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_kidneys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">R1b</span><span class="p">,</span> <span class="n">R1_lk</span><span class="p">,</span> <span class="n">R1_rk</span></div>


<div class="viewcode-block" id="AortaKidneys.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the data at given xdata</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): Tuple of 3 arrays with time points for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Tuple of 3 arrays with signals for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and value but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Public interface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signala</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">signal_lk</span><span class="p">,</span> <span class="n">signal_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_kidneys</span><span class="p">((</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">signala</span><span class="p">,</span> <span class="n">signal_lk</span><span class="p">,</span> <span class="n">signal_rk</span>
        <span class="c1"># Private interface with different input &amp; output types</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;aorta&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;kidneys&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_kidneys</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span></div>


<div class="viewcode-block" id="AortaKidneys.train">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> 
            <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the free parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): Tuple of 3 arrays with time points for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and value.</span>
<span class="sd">            ydata (tuple): Tuple of 3 arrays with signals for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and values but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            kwargs: any keyword parameters accepted by `scipy.optimize.curve_fit`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Model: A reference to the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Estimate BAT and S0b from data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Sref_lk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10_lk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Sref_rk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10_rk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Sref_lk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10_lk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Sref_rk</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10_rk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Srefb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0_lk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref_lk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0_rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref_rk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Train free aorta parameters on aorta data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;aorta&#39;</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Teb&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Train free kidney parameters on kidney data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;kidneys&#39;</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;RPF&#39;</span><span class="p">,</span><span class="s1">&#39;DRPF&#39;</span><span class="p">,</span> <span class="s1">&#39;DRF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;vp_lk&#39;</span><span class="p">,</span><span class="s1">&#39;Tt_lk&#39;</span><span class="p">,</span><span class="s1">&#39;Ta_lk&#39;</span><span class="p">,</span>
                <span class="s1">&#39;vp_rk&#39;</span><span class="p">,</span><span class="s1">&#39;Tt_rk&#39;</span><span class="p">,</span><span class="s1">&#39;Ta_rk&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Train all parameters on all data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AortaKidneys.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> 
                <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span>  
                <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the model fit against data</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): Tuple of 3 arrays with time points for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and value.</span>
<span class="sd">            ydata (tuple): Tuple of 3 arrays with signals for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and values but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            xlim (array_like, optional): 2-element array with lower and upper boundaries of the x-axis. Defaults to None.</span>
<span class="sd">            ref (tuple, optional): Tuple of optional test data in the form (x,y), where x is an array with x-values and y is an array with y-values. Defaults to None.</span>
<span class="sd">            fname (path, optional): Filepath to save the image. If no value is provided, the image is not saved. Defaults to None.</span>
<span class="sd">            show (bool, optional): If True, the plot is shown. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">Clk</span><span class="p">,</span> <span class="n">Crk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">),</span> <span class="p">(</span><span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">ax1</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span><span class="s1">&#39;darkred&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">ax3</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span><span class="s1">&#39;darkblue&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
                <span class="n">ax5</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span><span class="s1">&#39;darkblue&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">_plot_conc_aorta</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="n">_plot_conc_kidney</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Clk</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="n">_plot_conc_kidney</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Crk</span><span class="p">,</span> <span class="n">ax6</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="AortaKidneys.export_params">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.export_params">[docs]</a>
    <span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Aorta</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;T10b&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Blood precontrast T1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Injection rate&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;mL/sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bolus arrival time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;CO&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cardiac output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CO</span><span class="p">,</span> <span class="s2">&quot;mL/sec&quot;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Thl&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Heart-lung mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Dhl&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Heart-lung transit time dispersion&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Mean circulation time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span> 
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eb&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Body extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FF</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">FF</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Eo&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs extraction fraction&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;Teb&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Organs extracellular mean transit time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span><span class="p">,</span> <span class="s2">&quot;sec&quot;</span><span class="p">]</span>

        <span class="c1"># Kidneys</span>
        <span class="n">GFR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPF</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FF</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;GFR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Glomerular filtration rate&#39;</span><span class="p">,</span> <span class="n">GFR</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RPF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Renal plasma flow&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPF</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DRPF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Differential renal plasma flow&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;DRF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Differential renal function&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRF</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;FF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Filtration fraction&#39;</span><span class="p">,</span> <span class="n">GFR</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">RPF</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="c1"># Kidney LK</span>
        <span class="n">RPF_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">RPF</span>
        <span class="n">GFR_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRF</span><span class="o">*</span><span class="n">GFR</span>
        <span class="n">Tp_lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_lk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="o">/</span><span class="n">RPF_lk</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-RPF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Single-kidney plasma flow&#39;</span><span class="p">,</span> <span class="n">RPF_lk</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-GFR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Single-kidney glomerular filtration rate&#39;</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Single-kidney volume&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="p">,</span> <span class="s1">&#39;mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-Fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Plasma flow&#39;</span><span class="p">,</span> <span class="n">RPF_lk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-Tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Plasma mean transit time&#39;</span><span class="p">,</span> <span class="n">Tp_lk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-Ft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Tubular flow&#39;</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_lk</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-ve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Extracellular volume&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_lk</span><span class="p">,</span> <span class="s1">&#39;mL/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-FF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Filtration fraction&#39;</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="o">/</span><span class="n">RPF_lk</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Extraction fraction&#39;</span><span class="p">,</span> <span class="n">GFR_lk</span><span class="o">/</span><span class="p">(</span><span class="n">GFR_lk</span><span class="o">+</span><span class="n">RPF_lk</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-Tt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Tubular mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_lk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;LK-Ta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LK Arterial mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ta_lk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>

        <span class="c1"># Kidney RK</span>
        <span class="n">RPF_rk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DRPF</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">RPF</span>
        <span class="n">GFR_rk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DRF</span><span class="p">)</span><span class="o">*</span><span class="n">GFR</span>
        <span class="n">Tp_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_rk</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="o">/</span><span class="n">RPF_rk</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-RPF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Single-kidney plasma flow&#39;</span><span class="p">,</span> <span class="n">RPF_rk</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-GFR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Single-kidney glomerular filtration rate&#39;</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="p">,</span> <span class="s1">&#39;mL/sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Single-kidney volume&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="p">,</span> <span class="s1">&#39;mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-Fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Plasma flow&#39;</span><span class="p">,</span> <span class="n">RPF_rk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-Tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Plasma mean transit time&#39;</span><span class="p">,</span> <span class="n">Tp_rk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-Ft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Tubular flow&#39;</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_rk</span><span class="p">,</span> <span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-ve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Extracellular volume&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_rk</span><span class="p">,</span> <span class="s1">&#39;mL/mL&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-FF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Filtration fraction&#39;</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="o">/</span><span class="n">RPF_rk</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Extraction fraction&#39;</span><span class="p">,</span> <span class="n">GFR_rk</span><span class="o">/</span><span class="p">(</span><span class="n">GFR_rk</span><span class="o">+</span><span class="n">RPF_rk</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-Tt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Tubular mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt_rk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;RK-Ta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RK Arterial mean transit time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ta_rk</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_sdev</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AortaKidneys.cost">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaKidneys.html#dcmri.AortaKidneys.cost">[docs]</a>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;NRMS&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the goodness-of-fit</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): Tuple of 3 arrays with time points for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and value.</span>
<span class="sd">            ydata (tuple): Tuple of 3 arrays with signals for aorta, left kidney and right kidney, in that order. The three arrays can all be different in length and values but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            metric (str, optional): Which metric to use - options are: </span>
<span class="sd">                **RMS** (Root-mean-square);</span>
<span class="sd">                **NRMS** (Normalized root-mean-square); </span>
<span class="sd">                **AIC** (Akaike information criterion); </span>
<span class="sd">                **cAIC** (Corrected Akaike information criterion for small models);</span>
<span class="sd">                **BIC** (Baysian information criterion). Defaults to &#39;NRMS&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: goodness of fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span></div>
</div>

    

<div class="viewcode-block" id="AortaLiver2scan">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver2scan.html#dcmri.AortaLiver2scan">[docs]</a>
<span class="k">class</span> <span class="nc">AortaLiver2scan</span><span class="p">(</span><span class="n">AortaLiver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Joint model for aorta and liver signals measured over two scans.</span>

<span class="sd">    The model represents the liver as a two-compartment system and the body as a leaky loop with a heart-lung system and an organ system. The heart-lung system is modelled as a chain compartment and the organs are modelled as a two-compartment exchange model. Bolus injection into the system is modelled as a step function.</span>
<span class="sd">    </span>
<span class="sd">        **Injection parameters**</span>

<span class="sd">        - **weight** (float, default=70): Subject weight in kg.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **dose** (float, default=0.2): Injected contrast agent dose in mL per kg bodyweight.</span>
<span class="sd">        - **rate** (float, default=1): Contrast agent injection rate in mL per sec.</span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): Signal model.</span>
<span class="sd">        - **tmax** (float, default=120): Maximum acquisition time in sec.</span>
<span class="sd">        - **tacq** (float, default=None): Time to acquire a single dynamic in the first scan (sec). If this is not provided, tacq is taken from the difference between the first two data points.</span>
<span class="sd">        - **tacq2** (float, default=None): Time to acquire a single dynamic in the second scan (sec). If this is not provided, tacq is taken from the difference between the first two data points.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T. </span>
<span class="sd">        - **t0** (float, default=1): Baseline length in secs.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec. </span>
<span class="sd">        - **FA** (float, default=15): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **R10b** (float, default=1): Precontrast arterial relaxation rate in 1/sec. </span>
<span class="sd">        - **R102b** (float, default=1): Precontrast arterial relaxation rate in the second scan in 1/sec. </span>
<span class="sd">        - **R10l** (float, default=1): Baseline R1 for the liver.</span>
<span class="sd">        - **R102l** (float, default=1): Baseline R1 for the liver (second scan).</span>
<span class="sd">        - **S0b** (float, default=1): scale factor for the arterial MR signal in the first scan.</span>
<span class="sd">        - **S02b** (float, default=1): scale factor for the arterial MR signal in the second scan.</span>
<span class="sd">        - **S0l** (float, default=1): Scale factor for the liver signal.  </span>
<span class="sd">        - **S02l** (float, default=1): Scale factor for the liver signal (second scan).  </span>

<span class="sd">        **Whole body kinetic parameters**</span>

<span class="sd">        - **organs** (str, default=&#39;2cxm&#39;): Kinetic model for the organs.</span>
<span class="sd">        - **BAT** (float, default=60): Bolus arrival time, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **BAT2** (float, default=1200): Bolus arrival time in the second scan, i.e. time point where the indicator first arrives in the body. </span>
<span class="sd">        - **CO** (float, default=100): Cardiac output in mL/sec.</span>
<span class="sd">        - **Thl** (float, default=10): Mean transit time through heart and lungs.</span>
<span class="sd">        - **Dhl** (float, default=0.2): Dispersion through the heart-lung system, with a value in the range [0,1].</span>
<span class="sd">        - **To** (float, default=20): average time to travel through the organ&#39;s vasculature.</span>
<span class="sd">        - **Eb** (float, default=0.05): fraction of indicator extracted from the vasculature in a single pass. </span>
<span class="sd">        - **Eo** (float, default=0.15): Fraction of indicator entering the organs which is extracted from the blood pool.</span>
<span class="sd">        - **Teb** (float, default=120): Average time to travel through the organs extravascular space.</span>

<span class="sd">        **Liver kinetic parameters**</span>

<span class="sd">        - **kinetics** (str, default=&#39;non-stationary&#39;). Liver kinetic model, either stationary or non-stationary.</span>
<span class="sd">        - **Hct** (float, default=0.45): Hematocrit.</span>
<span class="sd">        - **Tel** (float, default=30): Mean transit time for extracellular space of liver and gut.</span>
<span class="sd">        - **De** (float, default=0.85): Dispersion in the extracellular space of liver an gut, in the range [0,1].</span>
<span class="sd">        - **ve** (float, default=0.3): Liver extracellular volume fraction.</span>
<span class="sd">        - **khe** (float, default=0.003): Hepatocellular uptake rate.</span>
<span class="sd">        - **Th** (float, default=1800): Hepatocellular transit time.</span>
<span class="sd">        - **khe_f** (float, default=0.003): Final hepatocellular uptake rate (non-stationary models).</span>
<span class="sd">        - **Th_f** (float, default=1800): Final hepatocellular transit time (non-stationary models).</span>
<span class="sd">        - **vol** (float, default=None): liver volume in mL (for whole liver export parameters).</span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **dt** (float, default=1): Internal time resolution of the AIF in sec. </span>
<span class="sd">        - **dose_tolerance** (fload, default=0.1): Stopping criterion for the whole-body model.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AortaLiver`</span>

<span class="sd">    Example:</span>

<span class="sd">        Use the model to reconstruct concentrations from experimentally derived signals.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_tissue` to generate synthetic test data from experimentally-derived concentrations:</span>

<span class="sd">        &gt;&gt;&gt; time, aif, roi, gt = dc.fake_tissue2scan(R10 = 1/dc.T1(3.0,&#39;liver&#39;))</span>
<span class="sd">        &gt;&gt;&gt; xdata = (time[0], time[1], time[0], time[1])</span>
<span class="sd">        &gt;&gt;&gt; ydata = (aif[0], aif[1], roi[0], roi[1])</span>
<span class="sd">        </span>
<span class="sd">        Build an aorta-liver model and parameters to match the conditions of the fake tissue data:</span>

<span class="sd">        &gt;&gt;&gt; model = dc.AortaLiver2scan(</span>
<span class="sd">        ...     dt = 0.5,</span>
<span class="sd">        ...     weight = 70,</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     dose = [0.2,0.2],</span>
<span class="sd">        ...     rate = 3,</span>
<span class="sd">        ...     field_strength = 3.0,</span>
<span class="sd">        ...     t0 = 10,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = 20,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the data:</span>

<span class="sd">        &gt;&gt;&gt; model.train(xdata, ydata, xtol=1e-3)</span>

<span class="sd">        Plot the reconstructed signals and concentrations and compare against the experimentally derived data:</span>

<span class="sd">        &gt;&gt;&gt; model.plot(xdata, ydata)</span>

<span class="sd">        We can also have a look at the model parameters after training:</span>

<span class="sd">        &gt;&gt;&gt; model.print_params(round_to=3)</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Free parameters with their errors (stdev)  </span>
<span class="sd">        -----------------------------------------  </span>
<span class="sd">        Bolus arrival time (BAT): 17.13 (1.771) sec</span>
<span class="sd">        Cardiac output (CO): 208.547 (9.409) mL/sec</span>
<span class="sd">        Heart-lung mean transit time (Thl): 12.406 (2.137) sec</span>
<span class="sd">        Heart-lung transit time dispersion (Dhl): 0.459 (0.04)</span>
<span class="sd">        Organs mean transit time (To): 30.912 (3.999) sec</span>
<span class="sd">        Extraction fraction (Eb): 0.064 (0.032)</span>
<span class="sd">        Liver extracellular mean transit time (Tel): 2.957 (0.452) sec</span>
<span class="sd">        Liver extracellular dispersion (De): 1.0 (0.146)</span>
<span class="sd">        Liver extracellular volume fraction (ve): 0.077 (0.007) mL/mL</span>
<span class="sd">        Hepatocellular uptake rate (khe): 0.002 (0.001) mL/sec/mL</span>
<span class="sd">        Hepatocellular transit time (Th): 600.0 (1173.571) sec</span>
<span class="sd">        Organs extraction fraction (Eo): 0.2 (0.057)</span>
<span class="sd">        Organs extracellular mean transit time (Teb): 87.077 (56.882) sec</span>
<span class="sd">        Hepatocellular uptake rate (final) (khe_f): 0.001 (0.001) mL/sec/mL</span>
<span class="sd">        Hepatocellular transit time (final) (Th_f): 600.0 (623.364) sec</span>
<span class="sd">        ------------------</span>
<span class="sd">        Derived parameters</span>
<span class="sd">        ------------------</span>
<span class="sd">        Blood precontrast T1 (T10b): 1.629 sec</span>
<span class="sd">        Mean circulation time (Tc): 43.318 sec</span>
<span class="sd">        Liver precontrast T1 (T10l): 0.752 sec</span>
<span class="sd">        Biliary excretion rate (kbh): 0.002 mL/sec/mL</span>
<span class="sd">        Hepatocellular tissue uptake rate (Khe): 0.023 mL/sec/mL</span>
<span class="sd">        Biliary tissue excretion rate (Kbh): 0.002 mL/sec/mL</span>
<span class="sd">        Hepatocellular uptake rate (initial) (khe_i): 0.003 mL/sec/mL</span>
<span class="sd">        Hepatocellular transit time (initial) (Th_i): 600.0 sec</span>
<span class="sd">        Hepatocellular uptake rate variance (khe_var): 0.934</span>
<span class="sd">        Biliary tissue excretion rate variance (Kbh_var): 0.0</span>
<span class="sd">        Biliary excretion rate (initial) (kbh_i): 0.002 mL/sec/mL</span>
<span class="sd">        Biliary excretion rate (final) (kbh_f): 0.002 mL/sec/mL</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        
        <span class="c1"># Injection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">70.0</span>         
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">ca_std_dose</span><span class="p">(</span><span class="s1">&#39;gadoterate&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">ca_std_dose</span><span class="p">(</span><span class="s1">&#39;gadoterate&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Acquisition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="mi">120</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tacq2</span> <span class="o">=</span> <span class="kc">None</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mf">15.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.180</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;blood&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R102b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;blood&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S02b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10l</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;liver&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">R102l</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="s1">&#39;liver&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S02l</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">=</span> <span class="s1">&#39;2cxm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT2</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CO</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eb</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span> <span class="o">=</span> <span class="mi">120</span>
    
        <span class="c1"># Liver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">=</span> <span class="s1">&#39;non-stationary&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span> <span class="o">=</span> <span class="mf">0.45</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tel</span> <span class="o">=</span> <span class="mf">30.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">De</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ve</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">khe</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Th</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">khe_f</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Th_f</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="kc">None</span>   

        <span class="c1"># Prediction and training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;BAT2&#39;</span><span class="p">,</span><span class="s1">&#39;S02b&#39;</span><span class="p">,</span><span class="s1">&#39;S02l&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Tel&#39;</span><span class="p">,</span><span class="s1">&#39;De&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span><span class="s1">&#39;khe&#39;</span><span class="p">,</span><span class="s1">&#39;Th&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Teb&#39;</span><span class="p">,</span> <span class="s1">&#39;khe_f&#39;</span><span class="p">,</span><span class="s1">&#39;Th_f&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span>
             <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="p">],</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> 
             <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># Override defaults</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Internal flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_conc_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">organs</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2cxm&#39;</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Teb</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eo</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">ca_conc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="n">J1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">influx_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span><span class="p">)</span>
        <span class="n">J2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">influx_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BAT2</span><span class="p">)</span>
        <span class="n">Jb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">flux_aorta</span><span class="p">(</span><span class="n">J1</span> <span class="o">+</span> <span class="n">J2</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Eb</span><span class="p">,</span>
            <span class="n">heartlung</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pfcomp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span><span class="p">)],</span>
            <span class="n">organs</span> <span class="o">=</span> <span class="n">organs</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_tolerance</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">Jb</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">cb</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span>

    <span class="k">def</span> <span class="nf">_predict_aorta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="k">if</span> <span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tacq2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq2</span>
        <span class="k">if</span> <span class="n">tacq2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq2</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">tacq2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_aorta</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">R11</span> <span class="o">=</span> <span class="n">R1</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
        <span class="n">R12</span> <span class="o">=</span> <span class="n">R1</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">signal1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">signal2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S02b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">signal2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S02b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">t1</span><span class="p">],</span> <span class="n">signal1</span><span class="p">,</span> <span class="n">tacq</span><span class="p">),</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">t2</span><span class="p">],</span> <span class="n">signal2</span><span class="p">,</span> <span class="n">tacq2</span><span class="p">),</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_predict_liver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">tacq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq</span>
        <span class="k">if</span> <span class="n">tacq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tacq2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacq2</span>
        <span class="k">if</span> <span class="n">tacq2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacq2</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relax_liver</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">R11</span> <span class="o">=</span> <span class="n">R1</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span>
        <span class="n">R12</span> <span class="o">=</span> <span class="n">R1</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">signal1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">signal2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S02l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">signal2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S02l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">t1</span><span class="p">],</span> <span class="n">signal1</span><span class="p">,</span> <span class="n">tacq</span><span class="p">),</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">t2</span><span class="p">],</span> <span class="n">signal2</span><span class="p">,</span> <span class="n">tacq2</span><span class="p">),</span>
        <span class="p">)</span>

 
<div class="viewcode-block" id="AortaLiver2scan.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver2scan.html#dcmri.AortaLiver2scan.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span> <span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the data at given time points</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 4 arrays with time points for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The four arrays can be different in length and value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: tuple of 4 arrays with signals for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The arrays have the same length as its corresponding array of time points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Public interface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signal_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">((</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">signal_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_liver</span><span class="p">((</span><span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">signal_a</span> <span class="o">+</span> <span class="n">signal_l</span>
        <span class="c1"># Private interface with different in- and outputs</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;aorta&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_aorta</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">==</span> <span class="s1">&#39;liver&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_liver</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span></div>



<div class="viewcode-block" id="AortaLiver2scan.train">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver2scan.html#dcmri.AortaLiver2scan.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># x,y: (aorta scan 1, aorta scan 2, liver scan 1, liver scan 2)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the free parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 4 arrays with time points for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The four arrays can be different in length and value.</span>
<span class="sd">            ydata (tuple): tuple of 4 arrays with signals for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The arrays can be different in length but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            kwargs: any keyword parameters accepted by `scipy.optimize.curve_fit`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AortaLiver2scan: A reference to the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Estimate BAT</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Thl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dhl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">)</span><span class="o">*</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BAT2</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">D</span><span class="p">)</span><span class="o">*</span><span class="n">T</span>

        <span class="c1"># Estimate S0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Sref2b</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R102b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Srefl</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
            <span class="n">Sref2l</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R102l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Srefb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Sref2b</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R102b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Srefl</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
            <span class="n">Sref2l</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R102l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>

        <span class="n">n0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">),</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Srefb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S02b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref2b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Srefl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S02l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref2l</span>

        <span class="n">f</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

        <span class="c1"># Train free aorta parameters on aorta data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;aorta&#39;</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BAT&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span><span class="s1">&#39;Thl&#39;</span><span class="p">,</span><span class="s1">&#39;Dhl&#39;</span><span class="p">,</span><span class="s1">&#39;To&#39;</span><span class="p">,</span><span class="s1">&#39;Eb&#39;</span><span class="p">,</span><span class="s1">&#39;Eo&#39;</span><span class="p">,</span><span class="s1">&#39;Teb&#39;</span><span class="p">,</span><span class="s1">&#39;BAT2&#39;</span><span class="p">,</span><span class="s1">&#39;S02b&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>       

        <span class="c1"># Train free liver parameters on liver data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="s1">&#39;liver&#39;</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tel&#39;</span><span class="p">,</span><span class="s1">&#39;De&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span><span class="s1">&#39;khe&#39;</span><span class="p">,</span><span class="s1">&#39;Th&#39;</span><span class="p">,</span><span class="s1">&#39;khe_f&#39;</span><span class="p">,</span><span class="s1">&#39;Th_f&#39;</span><span class="p">,</span><span class="s1">&#39;S02l&#39;</span><span class="p">]</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isel</span><span class="p">]]</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ydata</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 

        <span class="c1"># Train all parameters on all data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="AortaLiver2scan.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver2scan.html#dcmri.AortaLiver2scan.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span>
             <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the model fit against data</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 4 arrays with time points for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The four arrays can be different in length and value.</span>
<span class="sd">            ydata (tuple): tuple of 4 arrays with signals for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The arrays can be different in length but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            xlim (array_like, optional): 2-element array with lower and upper boundaries of the x-axis. Defaults to None.</span>
<span class="sd">            ref (tuple, optional): Tuple of optional test data in the form (x,y), where x is an array with x-values and y is an array with y-values. Defaults to None.</span>
<span class="sd">            fname (path, optional): Filepath to save the image. If no value is provided, the image is not saved. Defaults to None.</span>
<span class="sd">            show (bool, optional): If True, the plot is shown. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ta1</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ta2</span> <span class="o">=</span> <span class="n">t</span><span class="p">[(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">tl1</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">tl2</span> <span class="o">=</span> <span class="n">t</span><span class="p">[(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">xdata</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">xdata</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">((</span><span class="n">ta1</span><span class="p">,</span><span class="n">ta2</span><span class="p">,</span><span class="n">tl1</span><span class="p">,</span><span class="n">tl2</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">_plot_data2scan</span><span class="p">((</span><span class="n">ta1</span><span class="p">,</span><span class="n">ta2</span><span class="p">),</span> <span class="n">sig</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> 
                <span class="n">ax1</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span><span class="s1">&#39;darkred&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">_plot_data2scan</span><span class="p">((</span><span class="n">tl1</span><span class="p">,</span><span class="n">tl2</span><span class="p">),</span> <span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> 
                <span class="n">ax3</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span><span class="s1">&#39;darkblue&#39;</span><span class="p">],</span> 
                <span class="n">test</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_plot_conc_aorta</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="n">_plot_conc_liver</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="AortaLiver2scan.cost">
<a class="viewcode-back" href="../../generated/api/dcmri.AortaLiver2scan.html#dcmri.AortaLiver2scan.cost">[docs]</a>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;NRMS&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the goodness-of-fit</span>

<span class="sd">        Args:</span>
<span class="sd">            xdata (tuple): tuple of 4 arrays with time points for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The four arrays can be different in length and value.</span>
<span class="sd">            ydata (tuple): tuple of 4 arrays with signals for aorta in the first scan, aorta in the second stand, liver in the first scan, and liver in the second scan, in that order. The arrays can be different in length but each has to have the same length as its corresponding array of time points.</span>
<span class="sd">            metric (str, optional): Which metric to use - options are: </span>
<span class="sd">                **RMS** (Root-mean-square);</span>
<span class="sd">                **NRMS** (Normalized root-mean-square); </span>
<span class="sd">                **AIC** (Akaike information criterion); </span>
<span class="sd">                **cAIC** (Corrected Akaike information criterion for small models);</span>
<span class="sd">                **BIC** (Baysian information criterion). Defaults to &#39;NRMS&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: goodness of fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span></div>
</div>

    
    

<span class="c1"># Helper functions for plotting</span>

<span class="k">def</span> <span class="nf">_plot_conc_aorta</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cb</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Concentration (mM)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aorta&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_conc_liver</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Tissue concentration (mM)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extracellular&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Hepatocytes&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tissue&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_conc_kidney</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Tissue concentration (mM)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Plasma&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tubuli&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tissue&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_data2scan</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">sig</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> 
        <span class="n">xdata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">ydata</span><span class="p">:</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> 
        <span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MR Signal (a.u.)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ydata</span><span class="p">),</span> 
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fitted data&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> 
            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test data&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_data1scan</span><span class="p">(</span><span class="n">t</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">xdata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ydata</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span> 
        <span class="n">test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MR Signal (a.u.)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fitted data&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test data&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, dcmri maintainers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>