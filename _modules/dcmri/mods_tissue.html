
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dcmri.mods_tissue &#8212; dcmri 0.6.8 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=cd8af66b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=ac3b80e6"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dcmri/mods_tissue';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/tristan-logo.jpg" class="logo__image only-light" alt="dcmri 0.6.8 documentation - Home"/>
    <script>document.write(`<img src="../../_static/tristan-logo.jpg" class="logo__image only-dark" alt="dcmri 0.6.8 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial/index.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../generated/examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute/index.html">
    Contribute
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../releases/index.html">
    Releases
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../about/index.html">
    About
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/QIB-Sheffield/dcmri" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial/index.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../generated/examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contribute/index.html">
    Contribute
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../releases/index.html">
    Releases
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/QIB-Sheffield/dcmri" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">dcmri.mods_tissue</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for dcmri.mods_tissue</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">ArtistAnimation</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dcmri</span> <span class="k">as</span> <span class="nn">dc</span>


<span class="k">try</span><span class="p">:</span> 
    <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="k">except</span><span class="p">:</span> 
    <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>



<div class="viewcode-block" id="TissueArray">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray">[docs]</a>
<span class="k">class</span> <span class="nc">TissueArray</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">ArrayModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pixel-based model for vascular-interstitial tissues.</span>

<span class="sd">    The model accepts the following parameters:</span>

<span class="sd">        - **shape** (array-like, default=(32,32)): shape of the pixel array, not including the time dimensions. Any number of dimensions are allowed. </span>
<span class="sd">        - **parallel** (bool, default=False): use parallel computing during training or not. </span>
<span class="sd">        - **verbose** (int, default=0): verbosity during computation. 0: no feedback, 1: show progress bar.</span>

<span class="sd">        **Input function**</span>

<span class="sd">        - **aif** (array-like, default=None): Signal-time curve in a feeding artery. If AIF is set to None, then the parameter ca must be provided (arterial concentrations).</span>
<span class="sd">        - **ca** (array-like, default=None): Plasma concentration (M) in the arterial input. Must be provided when aif = None, ignored otherwise. </span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **t** (array-like, default=None): Time points (sec) of the aif. If t is not provided, the temporal sampling is uniform with interval dt.</span>
<span class="sd">        - **dt** (float, default=1.0): Time interval of the AIF in sec.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec.</span>
<span class="sd">        - **FA** (array, default=np.full(shape, 15)): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>
<span class="sd">        - **TP** (float, default=0): Preparation delay in a saturation-recovery sequence.</span>
<span class="sd">        - **TS** (float, default=None): Sampling duration, or duration of the readout for a single time point. If not provided, and sampling is uniform, TS is assumed to be equal to the uniform time interval. TS is required if sampling is non-uniform.</span>

<span class="sd">        **Tracer-kinetic parameters**</span>

<span class="sd">        - **kinetics** (str, default=&#39;HF&#39;): Tracer-kinetic model (see below for options)</span>
<span class="sd">        - **Hct** (float, default=0.45): Hematocrit.</span>
<span class="sd">        - **Fp** (array, default=np.full(shape, 0.01)): Plasma flow, or flow of plasma into the plasma compartment (mL/sec/mL).</span>
<span class="sd">        - **PS** (array, default=np.full(shape, 0.003)): Permeability-surface area product: volume of plasma cleared of indicator per unit time and per unit tissue (mL/sec/mL).</span>
<span class="sd">        - **vp** (array, default=np.full(shape, 0.1)): Plasma volume, or volume fraction of the plasma compartment (mL/mL). </span>
<span class="sd">        - **ve** (array, default=np.full(shape, 0.5)): Extravascular, extracellular volume: volume fraction of the interstitial compartment (mL/mL).</span>
<span class="sd">        - **Ktrans** (array, default=np.full(shape, 0.0023)): Volume transfer constant (mL/sec/mL).</span>
<span class="sd">        - **v** (array, default=np.full(shape, 0.6)): Extracellular volume fraction (mL/mL).</span>

<span class="sd">        **Water-kinetic parameters**</span>

<span class="sd">        - **water_exchange** (str, default=&#39;fast&#39;): Water exchange regime (&#39;fast&#39;, &#39;none&#39; or &#39;any&#39;).</span>
<span class="sd">        - **PSe** (array, default=np.full(shape, 10)): Transendothelial water permeability-surface area product: PS for water across the endothelium (mL/sec/mL).</span>
<span class="sd">        - **PSc** (array, default=np.full(shape, 10)): Transcytolemmal water permeability-surface area product: PS for water across the cell wall (mL/sec/mL).</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): imaging sequence.</span>
<span class="sd">        - **R10b** (float, default=1): Precontrast arterial relaxation rate in 1/sec. </span>
<span class="sd">        - **R10** (array, default=np.full(shape, 1)): Precontrast tissue relaxation rate in 1/sec.</span>
<span class="sd">        - **S0** (array, default=np.full(shape, 1)): Scale factor for the MR signal (a.u.).</span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **n0** (int): number of precontrast baseline signals.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    Notes:</span>

<span class="sd">        Possible values for the **kinetics** argument, along with relevant parameters:: </span>
<span class="sd">        </span>
<span class="sd">        - &#39;U&#39;: uptake tissue. Parameters: Fp</span>
<span class="sd">        - &#39;NX&#39;: no tracer exchange tissue. Parameters: Fp, vp</span>
<span class="sd">        - &#39;FX&#39;: fast tracer exchange tissue. Parameters: Fp, v</span>
<span class="sd">        - &#39;WV&#39;: weakly vascularized tissue - also known as *Tofts model*.Parameters: Ktrans, ve</span>
<span class="sd">        - &#39;HFU&#39;: high-flow uptake tissue - also known as *Patlak model*. Parameters: vp, PS</span>
<span class="sd">        - &#39;HF&#39;: high-flow tissue - also known as *extended Tofts model*, *extended Patlak model* or *general kinetic model*. Params = (vp, PS, ve, )</span>
<span class="sd">        - &#39;2CU&#39;: two-compartment uptake tissue. Parameters: Fp, vp, PS</span>
<span class="sd">        - &#39;2CX&#39;: two-compartment exchange tissue. Parameters: Fp, vp, PS, ve</span>

<span class="sd">    See Also:</span>
<span class="sd">        `Tissue`</span>

<span class="sd">    Example:</span>

<span class="sd">    Fit a coarse image of the brain using a 2-compartment exchange model.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_brain` to generate synthetic test data:</span>

<span class="sd">        &gt;&gt;&gt; n=8</span>
<span class="sd">        &gt;&gt;&gt; time, signal, aif, gt = dc.fake_brain(n)</span>
<span class="sd">        </span>
<span class="sd">        Build a tissue array model and set the constants to match the experimental conditions of the synthetic test data:</span>

<span class="sd">        &gt;&gt;&gt; shape = (n,n)</span>
<span class="sd">        &gt;&gt;&gt; model = dc.TissueArray(</span>
<span class="sd">        ...     shape = shape,</span>
<span class="sd">        ...     aif = aif,</span>
<span class="sd">        ...     dt = time[1],</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = np.full(shape, 20),</span>
<span class="sd">        ...     R10 = 1/gt[&#39;T1&#39;],</span>
<span class="sd">        ...     n0 = 15,</span>
<span class="sd">        ...     kinetics = &#39;2CX&#39;,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the ROI data:</span>

<span class="sd">        &gt;&gt;&gt; model.train(time, signal)</span>

<span class="sd">        Plot the reconstructed maps, along with their standard deviations and the ground truth for reference:</span>

<span class="sd">        &gt;&gt;&gt; model.plot(time, signal, ref=gt)</span>

<span class="sd">        As the left panel shows, the measured signals are accurately reconstructed by the model. However, while these simulated data are noise-free, they are temporally undersampled (dt = 1.5 sec). As a result the reconstruction of the parameter maps (right panel) is not perfect - as can be seen by comparison against the ground truth, or, in the absence of a ground truth, by inspecting the standard deviations. PS for instance is showing some areas where the value is overestimated and the standard deviations large. </span>
<span class="sd">        </span>
<span class="sd">        The interstitial volume fraction ve is wrong in a large part of the image, but this is for another reason: much of this tissue has an intact blood brain barrier, and therefore therefore the properties of the extravascular space are fundamentally unmeasureable. This type of error is dangerous because it cannot be detected by inspecting the standard deviations. When no ground truth is available, this therefore risks a misinterpretation of the results. The risk of this type of error can be reduced by applying model selection.</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Input function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aif</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Acquisition parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TS</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Tracer-kinetic parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">=</span> <span class="s1">&#39;HF&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span> <span class="o">=</span> <span class="mf">0.45</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Water-kinetic parameters (TODO: what are typical values?)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Signal parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;muscle&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># training parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="n">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># sdevs</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sdev_&#39;</span> <span class="o">+</span> <span class="n">par</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Tissue</span><span class="p">(</span>

            <span class="c1"># Input function</span>
            <span class="n">aif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aif</span><span class="p">,</span>
            <span class="n">ca</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>
            
            <span class="c1"># Acquisition parameters</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span>
            <span class="n">field_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span>
            <span class="n">FA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">TR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span>
            <span class="n">TC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">,</span>
            <span class="n">TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS</span><span class="p">,</span>
            
            <span class="c1"># Tracer-kinetic parameters</span>
            <span class="n">kinetics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span><span class="p">,</span>
            <span class="n">Hct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">,</span>
            <span class="n">Fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">PS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">ve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>

            <span class="c1"># Water-kinetic parameters </span>
            <span class="n">water_exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span><span class="p">,</span>
            <span class="n">PSe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSe</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">PSc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSc</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>

            <span class="c1"># Signal parameters</span>
            <span class="n">R10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">R10b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>

            <span class="c1"># training parameters</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">,</span>
            <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">,</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>

            <span class="c1"># Dependents</span>
            <span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_train_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">pix</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_train_curve</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix</span><span class="o">.</span><span class="n">S0</span> 
        <span class="k">return</span> <span class="n">pix</span><span class="p">,</span> <span class="n">p</span>

    
<div class="viewcode-block" id="TissueArray.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the data at given time points</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: Array of predicted y-values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span></div>



<div class="viewcode-block" id="TissueArray.train">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the free parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>
<span class="sd">            signal (array-like): Array of signal curves. Any number of dimensions is allowed but the last dimension must be time. </span>
<span class="sd">            kwargs: any keyword parameters accepted by `Tissue.train`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TissueArray: A reference to the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="TissueArray.cost">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.cost">[docs]</a>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;NRMS&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the goodness-of-fit</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>
<span class="sd">            signal (array-like): Array of signal curves. Any number of dimensions is allowed but the last dimension must be time. </span>
<span class="sd">            metric (str, optional): Which metric to use - options are &#39;RMS&#39; (Root-mean-square), &#39;NRMS&#39; (Normalized root-mean-square), &#39;AIC&#39; (Akaike information criterion), &#39;cAIC&#39; (Corrected Akaike information criterion for small models) or &#39;BIC&#39; (Bayesian information criterion). Defaults to &#39;NRMS&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: goodness of fit in each element of the data array. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span></div>



<div class="viewcode-block" id="TissueArray.export_params">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.export_params">[docs]</a>
    <span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">_export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
                <span class="n">sdev</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sdev_&#39;</span> <span class="o">+</span> <span class="n">par</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sdev</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pars</span></div>



<div class="viewcode-block" id="TissueArray.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="p">{},</span> <span class="n">vmax</span><span class="o">=</span><span class="p">{},</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot parameter maps</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>
<span class="sd">            signal (array-like): Array of signal curves. Any number of dimensions is allowed but the last dimension is time. </span>
<span class="sd">            vmin (dict, optional): Minimum values on display for given parameters. Defaults to {}.</span>
<span class="sd">            vmax (dict, optional): Maximum values on display for given parameters. Defaults to {}.</span>
<span class="sd">            cmap (str, optional): matplotlib colormap. Defaults to &#39;gray&#39;.</span>
<span class="sd">            ref (dict, optional): Reference images - typically used to display ground truth data when available. Keys are &#39;signal&#39; (array of data in the same shape as signal), and the parameter maps to show. Defaults to None.</span>
<span class="sd">            fname (str, optional): File path to save image. Defaults to None.</span>
<span class="sd">            show (bool, optional): Determine whether the image is shown or not. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Features that are not currently implemented. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cannot plot 1D images.&#39;</span><span class="p">)</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="k">if</span> <span class="s1">&#39;S0&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">3</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncols</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">figcols</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subfigures</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># Left panel: signal</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">figcols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">figcols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>           

            <span class="c1"># Signal maps</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;max(signal)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;mean(signal)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

            <span class="c1"># Right panel: free parameters</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">figcols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">figcols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> 
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;reconstruction&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;std devs&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmin</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmax</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">v0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">v1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sdev_&#39;</span> <span class="o">+</span> <span class="n">par</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sdev_&#39;</span> <span class="o">+</span> <span class="n">par</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">v0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">v1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>  
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">v0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">v1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>         
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;3D plot not yet implemented&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

        

<div class="viewcode-block" id="TissueArray.plot_signals">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.plot_signals">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot measured and reconstructed dynamic signals.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>
<span class="sd">            signal (array-like): Array of signal curves. Any number of dimensions is allowed but the last dimension is time. </span>
<span class="sd">            cmap (str, optional): matplotlib colormap. Defaults to &#39;gray&#39;.</span>
<span class="sd">            ref (dict, optional): Reference images - typically used to display ground truth data when available. Keys are &#39;signal&#39; (array of data in the same shape as signal), and the parameter maps to show. Defaults to None.</span>
<span class="sd">            fname (str, optional): File path to save image. Defaults to None.</span>
<span class="sd">            show (bool, optional): Determine whether the image is shown or not. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Features that are not currently implemented. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cannot plot 1D images.&#39;</span><span class="p">)</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">3</span>
            <span class="c1">#fig = plt.figure(figsize=(ncols*2, nrows*2), layout=&#39;constrained&#39;)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncols</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

            <span class="c1"># Left panel: signal</span>
            <span class="c1">#figcols[0].suptitle(&#39;Signal&#39;, fontsize=&#39;x-large&#39;)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">)</span>
            <span class="c1">#figcols[0].subplots_adjust(left=0, right=1, bottom=0, top=1, hspace=0.00, wspace=0)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>  
            <span class="c1"># data animation</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;signal(time)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">signal</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
            <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">signal</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span> 
                <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">im</span><span class="p">])</span> 
            <span class="n">anim_data</span> <span class="o">=</span> <span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ims</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="c1"># fit animation</span>
            <span class="c1">#ax[1,0].set_title(&#39;model fit&#39;, rotation=&#39;vertical&#39;, x=-0.1,y=0.5)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;model fit&#39;</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">yfit</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
            <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yfit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">yfit</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span> 
                <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">im</span><span class="p">])</span> 
            <span class="n">anim_fit</span> <span class="o">=</span> <span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ims</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="c1"># truth animation</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
                <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span> 
                    <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">im</span><span class="p">])</span> 
                <span class="n">anim_truth</span> <span class="o">=</span> <span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ims</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>               

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>         
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;3D plot not yet implemented&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="TissueArray.plot_params">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.plot_params">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="p">{},</span> <span class="n">vmax</span><span class="o">=</span><span class="p">{},</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show parameter distributions in regions of interest.</span>

<span class="sd">        Args:</span>
<span class="sd">            roi (dict, optional): Dictionary with masks for regions-of-interest to be shown in the plot. if none is provided, the entire array is shown. Defaults to None.</span>
<span class="sd">            vmin (dict, optional): Minimum values on display for given parameters. Defaults to {}.</span>
<span class="sd">            vmax (dict, optional): Maximum values on display for given parameters. Defaults to {}.</span>
<span class="sd">            cmap (str, optional): matplotlib colormap. Defaults to &#39;gray&#39;.</span>
<span class="sd">            ref (dict, optional): Reference images - typically used to display ground truth data when available. Keys are &#39;signal&#39; (array of data in the same shape as ydata), and the parameter maps to show. Defaults to None.</span>
<span class="sd">            fname (str, optional): File path to save image. Defaults to None.</span>
<span class="sd">            show (bool, optional): Determine whether the image is shown or not. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="k">if</span> <span class="s1">&#39;S0&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nrows</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>  
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">ref</span><span class="p">[</span><span class="n">par</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmin</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
                <span class="n">v1</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmax</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">v0</span> <span class="o">!=</span> <span class="n">v1</span><span class="p">:</span>
                    <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">v0</span><span class="p">,</span><span class="n">v1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">v0</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.9</span><span class="o">*</span><span class="n">v0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">v0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">vmin</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">vmax</span><span class="p">[</span><span class="n">par</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">),</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">vmin</span><span class="p">[</span><span class="n">par</span><span class="p">],</span> <span class="n">vmax</span><span class="p">[</span><span class="n">par</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reconstructed&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nrows</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">roi</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>  
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)[</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">ref</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">v0</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmin</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">vmax</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="n">v0</span> <span class="o">!=</span> <span class="n">v1</span><span class="p">:</span>
                        <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">v0</span><span class="p">,</span><span class="n">v1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">v0</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.9</span><span class="o">*</span><span class="n">v0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">v0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="n">hrange</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">)[</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="n">hrange</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reconstructed&#39;</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="TissueArray.plot_fit">
<a class="viewcode-back" href="../../generated/api/dcmri.TissueArray.html#dcmri.TissueArray.plot_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> 
            <span class="n">hist_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot time curves and fits in representative pixels.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): 1D array with time points.</span>
<span class="sd">            signal (array-like): Array of signal curves. Any number of dimensions is allowed but the last dimension is time. </span>
<span class="sd">            hist_kwargs (dict, optional): Keyword arguments to be passed on the matlotlib&#39;s hist() finction. Defaults to {}.</span>
<span class="sd">            roi (dict, optional): Dictionary with masks for regions-of-interest to be shown in the plot. if none is provided, the entire array is shown. Defaults to None.</span>
<span class="sd">            ref (dict, optional): Reference images - typically used to display ground truth data when available. Keys are &#39;signal&#39; (array of data in the same shape as signal), and the parameter maps to show. Defaults to None.</span>
<span class="sd">            fname (str, optional): File path to save image. Defaults to None.</span>
<span class="sd">            show (bool, optional): Determine whether the image is shown or not. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nt</span><span class="p">))</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nt</span><span class="p">))</span>
        <span class="c1">#rms = 100*np.linalg.norm(signal-yfit, axis=-1)/np.linalg.norm(signal, axis=-1)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">signal</span><span class="o">-</span><span class="n">yfit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fit error histogram&#39;</span><span class="p">,</span> <span class="s1">&#39;5th perc&#39;</span><span class="p">,</span> <span class="s1">&#39;25th perc&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;75th perc&#39;</span><span class="p">,</span> <span class="s1">&#39;95th perc&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nrows</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> 
                    <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span> 
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                 <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">_plot_roi</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;all pixels&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">nrows</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> 
                    <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                 <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">roi</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_plot_roi</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Truth&#39;</span><span class="p">,</span><span class="s1">&#39;Prediction&#39;</span><span class="p">,</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">()):</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>








<div class="viewcode-block" id="Tissue">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue">[docs]</a>
<span class="k">class</span> <span class="nc">Tissue</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Model for general vascular-interstitial tissues.</span>

<span class="sd">    The model accepts the following parameters:</span>

<span class="sd">        **Input function**</span>

<span class="sd">        - **aif** (array-like, default=None): Signal-time curve in a feeding artery. If AIF is set to None, then the parameter ca must be provided (arterial concentrations).</span>
<span class="sd">        - **ca** (array-like, default=None): Plasma concentration (M) in the arterial input. Must be provided when aif = None, ignored otherwise. </span>

<span class="sd">        **Acquisition parameters**</span>

<span class="sd">        - **t** (array-like, default=None): Time points (sec) of the aif. If t is not provided, the temporal sampling is uniform with interval dt.</span>
<span class="sd">        - **dt** (float, default=1.0): Time interval of the AIF in sec.</span>
<span class="sd">        - **field_strength** (float, default=3.0): Magnetic field strength in T.</span>
<span class="sd">        - **agent** (str, default=&#39;gadoterate&#39;): Contrast agent generic name.</span>
<span class="sd">        - **TR** (float, default=0.005): Repetition time, or time between excitation pulses, in sec.</span>
<span class="sd">        - **FA** (float, default=15): Nominal flip angle in degrees.</span>
<span class="sd">        - **TC** (float, default=0.1): Time to the center of k-space in a saturation-recovery sequence.</span>
<span class="sd">        - **TP** (float, default=0): Preparation delay in a saturation-recovery sequence.</span>
<span class="sd">        - **TS** (float, default=None): Sampling duration, or duration of the readout for a single time point. If not provided, and sampling is uniform, TS is assumed to be equal to the uniform time interval. TS is required if sampling is non-uniform.</span>

<span class="sd">        **Tracer-kinetic parameters**</span>

<span class="sd">        - **kinetics** (str, default=&#39;HF&#39;): Tracer-kinetic model (see below for options)</span>
<span class="sd">        - **Hct** (float, default=0.45): Hematocrit.</span>
<span class="sd">        - **Fp** (float, default=0.01): Plasma flow, or flow of plasma into the plasma compartment (mL/sec/mL).</span>
<span class="sd">        - **PS** (float, default=0.003): Permeability-surface area product: volume of plasma cleared of indicator per unit time and per unit tissue (mL/sec/mL).</span>
<span class="sd">        - **vp** (float, default=0.1): Plasma volume, or volume fraction of the plasma compartment (mL/mL). </span>
<span class="sd">        - **ve** (float, default=0.5): Extravascular, extracellular volume: volume fraction of the interstitial compartment (mL/mL).</span>
<span class="sd">        - **Ktrans** (float, default=0.0023): Volume transfer constant (mL/sec/mL).</span>
<span class="sd">        - **v** (float, default=0.6): Extracellular volume fraction (mL/mL).</span>

<span class="sd">        **Water-kinetic parameters**</span>

<span class="sd">        - **water_exchange** (str, default=&#39;fast&#39;): Water exchange regime (&#39;fast&#39;, &#39;none&#39; or &#39;any&#39;).</span>
<span class="sd">        - **PSe** (float, default=10): Transendothelial water permeability-surface area product: PS for water across the endothelium (mL/sec/mL).</span>
<span class="sd">        - **PSc** (float, default=10): Transcytolemmal water permeability-surface area product: PS for water across the cell wall (mL/sec/mL).</span>

<span class="sd">        **Signal parameters**</span>

<span class="sd">        - **sequence** (str, default=&#39;SS&#39;): imaging sequence.</span>
<span class="sd">        - **R10** (float, default=1): Precontrast tissue relaxation rate in 1/sec.</span>
<span class="sd">        - **R10b** (float, default=1): Precontrast arterial relaxation rate in 1/sec. </span>
<span class="sd">        - **S0** (float, default=1): Scale factor for the MR signal (a.u.).</span>

<span class="sd">        **Prediction and training parameters**</span>

<span class="sd">        - **n0** (int): number of precontrast baseline signals.</span>
<span class="sd">        - **free** (array-like): list of free parameters. The default depends on the kinetics parameter.</span>
<span class="sd">        - **bounds** (array-like): 2-element list with lower and upper bounds of the free parameters. The default depends on the kinetics parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict, optional): override defaults for any of the parameters.</span>

<span class="sd">    Notes:</span>

<span class="sd">        Possible values for the **kinetics** argument, along with relevant parameters:: </span>
<span class="sd">        </span>
<span class="sd">        - &#39;U&#39;: uptake tissue. Parameters: Fp</span>
<span class="sd">        - &#39;NX&#39;: no tracer exchange tissue. Parameters: Fp, vp</span>
<span class="sd">        - &#39;FX&#39;: fast tracer exchange tissue. Parameters: Fp, v</span>
<span class="sd">        - &#39;WV&#39;: weakly vascularized tissue - also known as *Tofts model*.Parameters: Ktrans, ve</span>
<span class="sd">        - &#39;HFU&#39;: high-flow uptake tissue - also known as *Patlak model*. Parameters: vp, PS</span>
<span class="sd">        - &#39;HF&#39;: high-flow tissue - also known as *extended Tofts model*, *extended Patlak model* or *general kinetic model*. Params = (vp, PS, ve, )</span>
<span class="sd">        - &#39;2CU&#39;: two-compartment uptake tissue. Parameters: Fp, vp, PS</span>
<span class="sd">        - &#39;2CX&#39;: two-compartment exchange tissue. Parameters: Fp, vp, PS, ve</span>

<span class="sd">    See Also:</span>
<span class="sd">        `Liver`, `Kidney`</span>

<span class="sd">    Example:</span>

<span class="sd">        Single time-curve analysis: fit extended Tofts model to data.</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        :context: close-figs</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import dcmri as dc</span>

<span class="sd">        Use `fake_tissue` to generate synthetic test data:</span>

<span class="sd">        &gt;&gt;&gt; time, aif, roi, gt = dc.fake_tissue(CNR=50)</span>
<span class="sd">        </span>
<span class="sd">        Build a tissue model and set the constants to match the experimental conditions of the synthetic test data:</span>

<span class="sd">        &gt;&gt;&gt; model = dc.Tissue(</span>
<span class="sd">        ...     aif = aif,</span>
<span class="sd">        ...     dt = time[1],</span>
<span class="sd">        ...     agent = &#39;gadodiamide&#39;,</span>
<span class="sd">        ...     TR = 0.005,</span>
<span class="sd">        ...     FA = 20,</span>
<span class="sd">        ...     n0 = 15,</span>
<span class="sd">        ... )</span>

<span class="sd">        Train the model on the ROI data:</span>

<span class="sd">        &gt;&gt;&gt; model.train(time, roi)</span>

<span class="sd">        Plot the reconstructed signals (left) and concentrations (right) and compare the concentrations against the noise-free ground truth:</span>

<span class="sd">        &gt;&gt;&gt; model.plot(time, roi, ref=gt)</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># Input function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aif</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Acquisition parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="s1">&#39;gadoterate&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TS</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Tracer-kinetic parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">=</span> <span class="s1">&#39;HF&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hct</span> <span class="o">=</span> <span class="mf">0.45</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PS</span> <span class="o">=</span> <span class="mf">0.003</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ve</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># Water-kinetic parameters (TODO: what are typical values?)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSe</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSc</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Signal parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;muscle&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">.</span><span class="n">T1</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># # training parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="n">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>


<div class="viewcode-block" id="Tissue.time">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.time">[docs]</a>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an array of time points</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: time points in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aif</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either aif or ca must be provided.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span></div>



<div class="viewcode-block" id="Tissue.conc">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.conc">[docs]</a>
    <span class="k">def</span> <span class="nf">conc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the tissue concentration</span>

<span class="sd">        Args:</span>
<span class="sd">            sum (bool, optional): If True, returns the total concentrations. Else returns the concentration in the individual compartments. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Concentration in M</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Arterial concentrations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either aif or ca must be provided.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">cb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_src</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aif</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">cb</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aif</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R10b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Signal model &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="s1">&#39;is not (yet) supported.&#39;</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">cb</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span> 

        <span class="c1"># Tissue concentrations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;2CX&#39;</span><span class="p">:</span> <span class="c1"># (Fp, PS, vp, ve)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;2CX&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;2CU&#39;</span><span class="p">:</span> <span class="c1"># (Fp, PS, vp)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;2CU&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;HF&#39;</span><span class="p">:</span> <span class="c1"># (PS, vp, ve)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;HFU&#39;</span><span class="p">:</span> <span class="c1"># (Fp, PS, vp)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;HFU&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;WV&#39;</span><span class="p">:</span> <span class="c1"># (Ktrans, ve)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">0</span>    
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;FX&#39;</span><span class="p">)</span>        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;FX&#39;</span><span class="p">:</span> <span class="c1"># (Fp, v)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;FX&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;NX&#39;</span><span class="p">:</span> <span class="c1"># (Fp, vp)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;NX&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="c1"># (Fp)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">conc_tissue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">kinetics</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">C</span></div>



<div class="viewcode-block" id="Tissue.relax">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.relax">[docs]</a>
    <span class="k">def</span> <span class="nf">relax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the longitudinal relaxation rate</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Relaxation rate. Dimensions are (nt,) for a tissue in fast water exchange, or (nc,nt) for a multicompartment tissue outside the fast water exchange limit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">relaxivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_strength</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FX&#39;</span><span class="p">,</span> <span class="s1">&#39;NX&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">]:</span>
                <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CX&#39;</span><span class="p">,</span> <span class="s1">&#39;HF&#39;</span><span class="p">]:</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
            <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="n">vb</span>
            <span class="n">R1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span>
            <span class="n">R1c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">R1b</span><span class="p">,</span> <span class="n">R1e</span><span class="p">,</span> <span class="n">R1c</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CU&#39;</span><span class="p">,</span><span class="s1">&#39;HFU&#39;</span><span class="p">]:</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
            <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="n">vb</span>
            <span class="n">R1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="p">)</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">R1b</span><span class="p">,</span> <span class="n">R1e</span><span class="p">))</span>    
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;WV&#39;</span><span class="p">,</span><span class="s1">&#39;FX&#39;</span><span class="p">]:</span>
            <span class="n">R1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span>
            <span class="n">R1c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">R1e</span><span class="p">,</span> <span class="n">R1c</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;NX&#39;</span><span class="p">:</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
            <span class="n">R1b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10b</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span><span class="o">/</span><span class="n">vb</span>
            <span class="n">R1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">R1b</span><span class="p">,</span> <span class="n">R1e</span><span class="p">))</span>  
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R10</span> <span class="o">+</span> <span class="n">r1</span><span class="o">*</span><span class="n">C</span>
        <span class="k">return</span> <span class="n">R1</span></div>



<div class="viewcode-block" id="Tissue.signal">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.signal">[docs]</a>
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the signal</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: the signal as a 1D array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CX&#39;</span><span class="p">,</span><span class="s1">&#39;HF&#39;</span><span class="p">]:</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CU&#39;</span><span class="p">,</span><span class="s1">&#39;HFU&#39;</span><span class="p">,</span><span class="s1">&#39;NX&#39;</span><span class="p">]:</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;WV&#39;</span><span class="p">,</span><span class="s1">&#39;FX&#39;</span><span class="p">]:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_exchange</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CX&#39;</span><span class="p">,</span><span class="s1">&#39;HF&#39;</span><span class="p">]:</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">]</span>
                <span class="n">PSw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSe</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">PSe</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSc</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSc</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                <span class="c1"># TODO: ADD diagonal element (flow term)!!</span>
                <span class="c1"># Also needs adding inflow </span>
                <span class="c1"># Fb = self.Fp/(1-self.Hct)</span>
                <span class="c1"># PSw = np.array([[Fb,self.PSe,0],[self.PSe,0,self.PSc],[0,self.PSc,0]])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Saturation-recovery not yet implemented for intermediate water exchange&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="n">PSw</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2CU&#39;</span><span class="p">,</span><span class="s1">&#39;HFU&#39;</span><span class="p">,</span><span class="s1">&#39;NX&#39;</span><span class="p">]:</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vb</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="p">]</span>
                <span class="c1"># TODO: ADD diagonal element (flow term)!!</span>
                <span class="c1"># Fb = self.Fp/(1-self.Hct)</span>
                <span class="c1"># PSw = np.array([[Fb,self.PSe],[self.PSe,0]])</span>
                <span class="n">PSw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSe</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">PSe</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Saturation-recovery not yet implemented for intermediate water exchange&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="n">PSw</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;WV&#39;</span><span class="p">,</span><span class="s1">&#39;FX&#39;</span><span class="p">]:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ve</span><span class="p">]</span>
                <span class="n">PSw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSc</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">PSc</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                <span class="c1"># TODO: ADD diagonal element (flow term)!!</span>
                <span class="c1"># FX:</span>
                <span class="c1"># Fb = self.Fp/(1-self.Hct)</span>
                <span class="c1"># PSw = np.array([[Fb,self.PSc],[self.PSc,0]])</span>
                <span class="c1"># WV:</span>
                <span class="c1"># PSw = np.array([[self.PSe,self.PSc],[self.PSc,0]])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Saturation-recovery not yet implemented for intermediate water exchange&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">PSw</span><span class="o">=</span><span class="n">PSw</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetics</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signal</span></div>



<div class="viewcode-block" id="Tissue.predict">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.predict">[docs]</a>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the data at given time points</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): Array of time points.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Array of predicted data for each element of *time*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The acquisition window is longer than the duration of the AIF. </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;The largest time point that can be predicted is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;min.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS</span><span class="p">)</span></div>


   
<div class="viewcode-block" id="Tissue.train">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;NLLS&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the free parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): Array with time points.</span>
<span class="sd">            signal (array-like): Array with measured signals for each element of *time*.</span>
<span class="sd">            method (str, optional): Method to use for training. Currently the only option is &#39;NNLS&#39; (Non-negative least squares) Default is &#39;NNLS&#39;.</span>
<span class="sd">            kwargs: any keyword parameters accepted by the specified fit method. For &#39;NNLS&#39; these are all parameters accepted by `scipy.optimize.curve_fit`, except for bounds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tissue: A reference to the model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Estimate S0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SR&#39;</span><span class="p">:</span>
            <span class="n">Sref</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_sr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TP</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="s1">&#39;SS&#39;</span><span class="p">:</span>
            <span class="n">Sref</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">signal_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FA</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Signal model &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="s1">&#39;is not (yet) supported.&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signal</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n0</span><span class="p">])</span> <span class="o">/</span> <span class="n">Sref</span>

        <span class="c1"># If there is no signal, set all free parameters to zero</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
    
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;NLLS&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PSMS&#39;</span><span class="p">:</span>
            <span class="c1"># Fit the complete model</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Fit an intravascular model with the same free parameters</span>
            <span class="n">iv</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1">#iv.kinetics = &#39;NX&#39;</span>
            <span class="n">iv</span><span class="o">.</span><span class="n">PS</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;PSc&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">iv</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
                    <span class="n">iv</span><span class="o">.</span><span class="n">free</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">iv</span><span class="o">.</span><span class="n">bounds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bound</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">bound</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># If the intravascular model has a lower AIC, take the free parameters from there</span>
            <span class="k">if</span> <span class="n">iv</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cAIC&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cAIC&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span>
                <span class="c1"># # If the tissue is 1-compartmental and the blood MTT &gt; 30s</span>
                <span class="c1"># # Assume the observed compartment is actually interstitial.</span>
                <span class="c1"># if iv.vp/iv.Fp &gt; 30:</span>
                <span class="c1">#     self.vp = 0</span>
                <span class="c1">#     self.Fp = 0</span>
                <span class="c1">#     self.PS = 0</span>
                <span class="c1">#     self.ve = iv.vp</span>
                <span class="c1">#     self.Ktrans = iv.Fp</span>
                <span class="c1">#     self.v = iv.vp</span>
            <span class="k">return</span> <span class="bp">self</span></div>


        
<div class="viewcode-block" id="Tissue.export_params">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.export_params">[docs]</a>
    <span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">_export_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_sdev</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Tissue.cost">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.cost">[docs]</a>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;NRMS&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the goodness-of-fit</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): Array with time points.</span>
<span class="sd">            signal (array-like): Array with measured signals for each element of *time*.</span>
<span class="sd">            metric (str, optional): Which metric to use - options are &#39;RMS&#39; (Root-mean-square), &#39;NRMS&#39; (Normalized root-mean-square), &#39;AIC&#39; (Akaike information criterion), &#39;cAIC&#39; (Corrected Akaike information criterion for small models) or &#39;BIC&#39; (Baysian information criterion). Defaults to &#39;NRMS&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: goodness of fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span></div>

    
    
<div class="viewcode-block" id="Tissue.plot">
<a class="viewcode-back" href="../../generated/api/dcmri.Tissue.html#dcmri.Tissue.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  
             <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the model fit against data.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (array-like): Array with time points.</span>
<span class="sd">            signal (array-like): Array with measured signals for each element of *time*.</span>
<span class="sd">            xlim (array_like, optional): 2-element array with lower and upper boundaries of the x-axis. Defaults to None.</span>
<span class="sd">            ref (tuple, optional): Tuple of optional test data in the form (x,y), where x is an array with x-values and y is an array with y-values. Defaults to None.</span>
<span class="sd">            fname (path, optional): Filepath to save the image. If no value is provided, the image is not saved. Defaults to None.</span>
<span class="sd">            show (bool, optional): If True, the plot is shown. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction of the MRI signals.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;signal&#39;</span> <span class="ow">in</span> <span class="n">ref</span><span class="p">:</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tissue ground truth&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted data&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MRI signal (a.u.)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reconstruction of concentrations.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tissue ground truth&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Arterial ground truth&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tissue prediction&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Arterial prediction&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Concentration (mM)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>






<span class="c1"># Helper functions</span>



<span class="k">def</span> <span class="nf">_plot_roi</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rms</span><span class="p">[</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">rms</span><span class="p">[</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">perc</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inroi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rms</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inroi</span> <span class="o">=</span> <span class="n">mask</span><span class="o">==</span><span class="mi">1</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="p">[(</span><span class="n">rms</span><span class="o">==</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">inroi</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perc</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">rms</span><span class="p">[</span><span class="n">inroi</span><span class="p">],</span> <span class="o">**</span><span class="n">hist_kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mf">5.0</span><span class="p">}</span>
        <span class="n">yref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ydata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yref</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth (5th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yref</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth (25th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yref</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth (median)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yref</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth (75th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yref</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth (95th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;darkblue&#39;</span><span class="p">}</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction (5th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction (25th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction (median)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction (75th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction (95th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;markersize&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;crimson&#39;</span><span class="p">}</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (5th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (25th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (median)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (75th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">4</span><span class="p">],:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (95th perc)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>    



<span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

    <span class="c1"># Preset parameters</span>
    <span class="k">if</span> <span class="s1">&#39;kinetics&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2CX&#39;</span><span class="p">:</span> <span class="c1"># TODO: change to 2CX</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">,</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2CU&#39;</span><span class="p">:</span> <span class="c1"># TODO: change to 2CU</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">,</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HF&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HFU&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WV&#39;</span><span class="p">:</span> 
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ktrans&#39;</span><span class="p">,</span><span class="s1">&#39;ve&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FX&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> 
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NX&#39;</span><span class="p">:</span> 
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">,</span><span class="s1">&#39;vp&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;kinetics&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> 
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fp&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;water_exchange&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>        
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;water_exchange&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">free</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;PSe&#39;</span><span class="p">,</span> <span class="s1">&#39;PSc&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

    <span class="c1"># Override defaults</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;TS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># With uniform sampling, assume TS=dt</span>
            <span class="n">model</span><span class="o">.</span><span class="n">TS</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Raise an error if sampling is not uniform</span>
            <span class="c1"># as the sampling duration is ambiguous in that case</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;For non-uniform time points, the sampling duration TS must be specified explicitly.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1"># With uniform sampling, assume TS=dt</span>
                <span class="n">model</span><span class="o">.</span><span class="n">TS</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Dependent parameters</span>
    <span class="k">if</span> <span class="s1">&#39;Ktrans&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Ktrans</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="o">/</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;v&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vp</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">ve</span>

<span class="k">def</span> <span class="nf">_export_params</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">Hct</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Fp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Plasma flow&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span><span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Permeability-surface area product&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span><span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Ktrans&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Volume transfer constant&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">Ktrans</span><span class="p">,</span><span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ve&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Extravascular extracellular volume&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span><span class="s1">&#39;mL/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;vb&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Blood volume&#39;</span><span class="p">,</span><span class="n">vb</span><span class="p">,</span><span class="s1">&#39;mL/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;vp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Plasma volume&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span><span class="s1">&#39;mL/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Extracellular volume&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s1">&#39;mL/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Te&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Extracellular mean transit time&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">ve</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="p">,</span><span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;kep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Extravascular transfer constant&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">Ktrans</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">ve</span><span class="p">,</span><span class="s1">&#39;1/sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Extraction fraction&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="o">/</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Tp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Plasma mean transit time&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">PS</span><span class="p">),</span><span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Tb&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Blood mean transit time&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span><span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mean transit time&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">v</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">Fp</span><span class="p">,</span><span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PSe&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Transendothelial water PS&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">PSe</span><span class="p">,</span><span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PSc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Transcytolemmal water PS&#39;</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">PSc</span><span class="p">,</span><span class="s1">&#39;mL/sec/mL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Twc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Intracellular water mean transit time&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vb</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">PSc</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Twi&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Interstitial water mean transit time&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ve</span><span class="o">/</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PSc</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">PSe</span><span class="p">),</span> <span class="s1">&#39;sec&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Twb&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;Intravascular water mean transit time&#39;</span><span class="p">,</span> <span class="n">vb</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">PSe</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">pars</span>





</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, dcmri maintainers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>